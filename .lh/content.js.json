{
    "sourceFile": "content.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 22,
            "patches": [
                {
                    "date": 1750310390265,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1750432495559,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -102,9 +102,8 @@\n \r\n   // ★APIキーをここに設定（ご自身のYouTube Data APIキーに差し替えてください）\r\n   const YOUTUBE_API_KEY = 'AIzaSyCB9iLVqz1AsLrYk83tILnILa7n6OzfEkg';\r\n \r\n-\r\n   // 動画IDをURLから取得\r\n   function getVideoId() {\r\n     const url = new URL(location.href);\r\n     return url.searchParams.get('v');\r\n"
                },
                {
                    "date": 1750432562299,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -162,9 +162,9 @@\n     } else {\r\n       return '今';\r\n     }\r\n   }  async function onAnalyzeClick() {\r\n-    showResult('解析中...', false);\r\n+    showResult('解析中です', false);\r\n     \r\n     const videoId = getVideoId();\r\n     if (!videoId) {\r\n       showResult('エラー: 動画IDが取得できませんでした', true);\r\n"
                },
                {
                    "date": 1750432607908,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -177,9 +177,9 @@\n     await new Promise(r => setTimeout(r, 1000));\r\n     const apiData = await fetchComments(videoId);\r\n     const apiCount = apiData.count;\r\n     \r\n-    showResult('解析が完了しました。', false);\r\n+    showResult('解析が完了しました。まもなく', false);\r\n     await new Promise(r => setTimeout(r, 1000));\r\n     \r\n     let resultMsg = '解析結果：\\n';\r\n     \r\n"
                },
                {
                    "date": 1750432620020,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -177,9 +177,9 @@\n     await new Promise(r => setTimeout(r, 1000));\r\n     const apiData = await fetchComments(videoId);\r\n     const apiCount = apiData.count;\r\n     \r\n-    showResult('解析が完了しました。まもなく', false);\r\n+    showResult('解析が完了しました。まもなく結果が表示されます。', false);\r\n     await new Promise(r => setTimeout(r, 1000));\r\n     \r\n     let resultMsg = '解析結果：\\n';\r\n     \r\n"
                },
                {
                    "date": 1750432626660,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -177,9 +177,9 @@\n     await new Promise(r => setTimeout(r, 1000));\r\n     const apiData = await fetchComments(videoId);\r\n     const apiCount = apiData.count;\r\n     \r\n-    showResult('解析が完了しました。まもなく結果が表示されます。', false);\r\n+    showResult('解析が完了しました。\\nまもなく結果が表示されます。', false);\r\n     await new Promise(r => setTimeout(r, 1000));\r\n     \r\n     let resultMsg = '解析結果：\\n';\r\n     \r\n"
                },
                {
                    "date": 1750432634495,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -177,9 +177,9 @@\n     await new Promise(r => setTimeout(r, 1000));\r\n     const apiData = await fetchComments(videoId);\r\n     const apiCount = apiData.count;\r\n     \r\n-    showResult('解析が完了しました。\\nまもなく結果が表示されます。', false);\r\n+    showResult('解析が完了しました。\\nまもなく解析結果が表示されます。', false);\r\n     await new Promise(r => setTimeout(r, 1000));\r\n     \r\n     let resultMsg = '解析結果：\\n';\r\n     \r\n"
                },
                {
                    "date": 1750432654513,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -186,9 +186,9 @@\n     if (ytCount === apiCount) {\r\n       resultMsg += '全てのコメントが表示されています。';\r\n     } else {\r\n       const hiddenCount = Math.max(0, apiCount - ytCount);\r\n-      resultMsg += '表示されていないコメントが見つかったため、コメント欄のトップに表示しました';\r\n+      resultMsg += '表示されていないコメントが見つかったため、コメント欄のに表示しました';\r\n       const hiddenComments = apiData.comments.slice(ytCount);\r\n       if (hiddenComments.length > 0) {\r\n         const newHiddenComments = hiddenComments.filter(comment => !displayedCommentIds.has(comment.id));\r\n         if (newHiddenComments.length > 0) {\r\n"
                },
                {
                    "date": 1750432660723,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -186,9 +186,9 @@\n     if (ytCount === apiCount) {\r\n       resultMsg += '全てのコメントが表示されています。';\r\n     } else {\r\n       const hiddenCount = Math.max(0, apiCount - ytCount);\r\n-      resultMsg += '表示されていないコメントが見つかったため、コメント欄のに表示しました';\r\n+      resultMsg += '表示されていないコメントが見つかったため、コメント欄の上位に表示しました';\r\n       const hiddenComments = apiData.comments.slice(ytCount);\r\n       if (hiddenComments.length > 0) {\r\n         const newHiddenComments = hiddenComments.filter(comment => !displayedCommentIds.has(comment.id));\r\n         if (newHiddenComments.length > 0) {\r\n"
                },
                {
                    "date": 1750432667121,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -186,9 +186,9 @@\n     if (ytCount === apiCount) {\r\n       resultMsg += '全てのコメントが表示されています。';\r\n     } else {\r\n       const hiddenCount = Math.max(0, apiCount - ytCount);\r\n-      resultMsg += '表示されていないコメントが見つかったため、コメント欄の上位に表示しました';\r\n+      resultMsg += '表示されていないコメントが見つかったため、コメント欄のトップに表示しました';\r\n       const hiddenComments = apiData.comments.slice(ytCount);\r\n       if (hiddenComments.length > 0) {\r\n         const newHiddenComments = hiddenComments.filter(comment => !displayedCommentIds.has(comment.id));\r\n         if (newHiddenComments.length > 0) {\r\n"
                },
                {
                    "date": 1750432916865,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,18 +6,17 @@\n     if (!commentsHeader) return null;\r\n     const additional = commentsHeader.querySelector('#additional-section');\r\n     return additional;\r\n   }\r\n-\r\n   function insertAnalyzeButton() {\r\n     // 既にボタンがある場合は何もしない\r\n-    if (document.getElementById('ytcmtck-analyze-btn')) return;\r\n+    if (document.getElementById('ytcmtck-analyze-btn') || document.getElementById('ytcmtck-simple-analyze-btn')) return;\r\n     \r\n     const additional = findInsertTarget();\r\n     if (!additional) {\r\n       console.log('ytcmtck: #additional-section not found, retrying...');\r\n       return;\r\n-    }\r\n+    }      // 通常解析ボタン\r\n       const btn = document.createElement('button');\r\n     btn.id = 'ytcmtck-analyze-btn';\r\n     btn.textContent = 'コメント解析';\r\n     btn.style.marginLeft = '16px';\r\n@@ -33,11 +32,34 @@\n     btn.style.display = 'flex';\r\n     btn.style.alignItems = 'top';\r\n     btn.style.transition = 'background-color 0.1s ease';\r\n     \r\n+    // 簡易解析ボタン\r\n+    const simpleBtn = document.createElement('button');\r\n+    simpleBtn.id = 'ytcmtck-simple-analyze-btn';\r\n+    simpleBtn.textContent = '簡易解析';\r\n+    simpleBtn.style.marginLeft = '8px';\r\n+    simpleBtn.style.marginTop = '2px';\r\n+    simpleBtn.style.background = 'transparent';\r\n+    simpleBtn.style.color = '#606060';\r\n+    simpleBtn.style.border = '0px';\r\n+    simpleBtn.style.cursor = 'pointer';\r\n+    simpleBtn.style.fontSize = '1.2rem';\r\n+    simpleBtn.style.fontWeight = '400';\r\n+    simpleBtn.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n+    simpleBtn.style.height = '36px';\r\n+    simpleBtn.style.display = 'flex';\r\n+    simpleBtn.style.alignItems = 'top';\r\n+    simpleBtn.style.transition = 'color 0.1s ease';\r\n+    simpleBtn.style.textDecoration = 'none';\r\n+    simpleBtn.addEventListener('mouseenter', () => simpleBtn.style.color = '#0f0f0f');\r\n+    simpleBtn.addEventListener('mouseleave', () => simpleBtn.style.color = '#606060');\r\n+    \r\n     // #additional-section内部の最後に挿入\r\n     additional.appendChild(btn);\r\n+    additional.appendChild(simpleBtn);\r\n     btn.addEventListener('click', onAnalyzeClick);\r\n+    simpleBtn.addEventListener('click', onSimpleAnalyzeClick);\r\n     console.log('ytcmtck: 解析ボタンを挿入しました');\r\n   }\r\n \r\n   // MutationObserverでDOM変更を監視\r\n@@ -248,8 +270,150 @@\n       }\r\n     }\r\n     showResult(resultMsg, true);\r\n   }\r\n+  // 簡易解析（軽量版）\r\n+  async function onSimpleAnalyzeClick() {\r\n+    showResult('簡易解析中...', false);\r\n+    \r\n+    const videoId = getVideoId();\r\n+    if (!videoId) {\r\n+      showResult('エラー: 動画IDが取得できませんでした', true);\r\n+      return;\r\n+    }\r\n+    \r\n+    // 表示中コメント数を取得\r\n+    const ytComments = document.querySelectorAll('#contents #content-text');\r\n+    const ytCount = ytComments.length;\r\n+    \r\n+    // APIで最初の100件のみ取得（簡易版）\r\n+    const apiData = await fetchSimpleComments(videoId);\r\n+    const apiCount = apiData.count;\r\n+    \r\n+    let resultMsg = '簡易解析結果：\\n';\r\n+    resultMsg += `表示中コメント: ${ytCount}件\\n`;\r\n+    resultMsg += `API取得コメント: ${apiCount}件\\n`;\r\n+    \r\n+    if (ytCount === apiCount) {\r\n+      resultMsg += '\\n✅ 表示コメント数とAPI取得数が一致しています';\r\n+    } else if (apiCount > ytCount) {\r\n+      const hiddenCount = apiCount - ytCount;\r\n+      resultMsg += `\\n⚠️ ${hiddenCount}件のコメントが表示されていない可能性があります`;\r\n+      resultMsg += '\\n詳細な解析は「コメント解析」ボタンをお試しください';\r\n+    } else {\r\n+      resultMsg += '\\n📊 表示コメント数の方が多い状態です';\r\n+    }\r\n+    \r\n+    showResult(resultMsg, true);\r\n+  }\r\n+\r\n+  // 簡易版コメント取得（最初の100件のみ）\r\n+  async function fetchSimpleComments(videoId) {\r\n+    if (!videoId) return { count: 0, comments: [] };\r\n+    const apiUrl = `https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${videoId}&key=${YOUTUBE_API_KEY}&maxResults=100`;\r\n+    try {\r\n+      const res = await fetch(apiUrl);\r\n+      const data = await res.json();\r\n+      if (data.error) {\r\n+        console.error('YouTube API Error:', data.error);\r\n+        return { count: 0, comments: [] };\r\n+      }\r\n+      const commentCount = data.items ? data.items.length : 0;\r\n+      return { count: commentCount, comments: [] }; // 簡易版なので詳細データは不要\r\n+    } catch (e) {\r\n+      console.error('API fetch error:', e);\r\n+      return { count: 0, comments: [] };\r\n+    }\r\n+  }\r\n+\r\n+  // 通常解析（詳細版）\r\n+  async function onAnalyzeClick() {\r\n+    showResult('解析中です', false);\r\n+    \r\n+    const videoId = getVideoId();\r\n+    if (!videoId) {\r\n+      showResult('エラー: 動画IDが取得できませんでした', true);\r\n+      return;\r\n+    }\r\n+    \r\n+    const ytComments = document.querySelectorAll('#contents #content-text');\r\n+    const ytCount = ytComments.length;\r\n+    \r\n+    await new Promise(r => setTimeout(r, 1000));\r\n+    const apiData = await fetchComments(videoId);\r\n+    const apiCount = apiData.count;\r\n+    \r\n+    showResult('解析が完了しました。\\nまもなく解析結果が表示されます。', false);\r\n+    await new Promise(r => setTimeout(r, 1000));\r\n+    \r\n+    let resultMsg = '解析結果：\\n';\r\n+    \r\n+    if (ytCount === apiCount) {\r\n+      resultMsg += '全てのコメントが表示されています。';\r\n+    } else {\r\n+      const hiddenCount = Math.max(0, apiCount - ytCount);\r\n+      resultMsg += '表示されていないコメントが見つかったため、コメント欄のトップに表示しました';\r\n+      const hiddenComments = apiData.comments.slice(ytCount);\r\n+      if (hiddenComments.length > 0) {\r\n+        const newHiddenComments = hiddenComments.filter(comment => !displayedCommentIds.has(comment.id));\r\n+        if (newHiddenComments.length > 0) {\r\n+          newHiddenComments.forEach((comment, index) => {\r\n+            displayedCommentIds.add(comment.id);\r\n+            const commentElement = document.createElement('ytd-comment-view-model');\r\n+            commentElement.className = 'style-scope ytd-comment-thread-renderer';\r\n+            commentElement.setAttribute('data-ytcmtck-hidden', 'true');\r\n+            commentElement.style.borderRadius = '8px';\r\n+            commentElement.style.marginBottom = '16px';\r\n+            commentElement.innerHTML = `\r\n+            <div id=\"body\" class=\"style-scope ytd-comment-view-model\">              <div id=\"author-thumbnail\" class=\"style-scope ytd-comment-view-model\">\r\n+                <button id=\"author-thumbnail-button\" class=\"style-scope ytd-comment-view-model\" style=\"border: none; background: none; padding: 0; cursor: pointer;\" aria-label=\"${comment.author}\">\r\n+                  <yt-img-shadow fit=\"\" height=\"40\" width=\"40\" class=\"style-scope ytd-comment-view-model no-transition\" style=\"background-color: transparent;\">\r\n+                    <img style=\"width: 40px; height: 40px; border-radius: 50%; object-fit: cover;\" src=\"${comment.authorProfileImageUrl}\" alt=\"${comment.author}\" onerror=\"this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFNUU3RUIiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNiIgcj0iNiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNMzQgMzJDMzQgMjYuNDc3MiAyOS41MjI4IDIyIDI0IDIySDIwSDEyQzEwLjg5NTQgMjIgMTAgMjIuODk1NCAxMCAyNFYzNEgzNFYzMloiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'\">\r\n+                  </yt-img-shadow>\r\n+                </button>\r\n+              </div>\r\n+              <div id=\"main\" class=\"style-scope ytd-comment-view-model\">\r\n+                <div id=\"header\" class=\"style-scope ytd-comment-view-model\" style=\"display: flex; align-items: center; flex-wrap: wrap; gap: 8px;\">\r\n+                  <h3 class=\"style-scope ytd-comment-view-model\" style=\"margin: 0; font-size: 13px; line-height: 18px; font-weight: 500;\"> \r\n+                    <a class=\"yt-simple-endpoint style-scope ytd-comment-view-model\" href=\"${comment.authorChannelUrl}\" style=\"color: #0f0f0f; text-decoration: none;\">\r\n+                      <span class=\"style-scope ytd-comment-view-model\">${comment.author}</span>\r\n+                    </a>\r\n+                  </h3>\r\n+                  <span dir=\"auto\" style=\"color: #606060; font-size: 12px; line-height: 18px;\">\r\n+                    <a class=\"yt-simple-endpoint style-scope ytd-comment-view-model\" href=\"/watch?v=${getVideoId()}&lc=${comment.id}\" style=\"color: inherit; text-decoration: none;\">\r\n+                      ${formatTimeAgo(comment.publishedAt)}\r\n+                    </a>\r\n+                  </span>\r\n+                </div>\r\n+                <div style=\"margin-top: 2px;\">\r\n+                  <span style=\"color: #0f0f0f; font-size: 14px; line-height: 20px; white-space: pre-wrap;\">${comment.text}</span>\r\n+                </div>                <div style=\"margin-top: 8px; display: flex; align-items: center; gap: 8px;\">\r\n+                  <button style=\"background: none; border: none; padding: 0px; border-radius: 18px; cursor: pointer; display: flex; align-items: center; gap: 6px;\" onmouseover=\"this.style.backgroundColor='#f2f2f2'\" onmouseout=\"this.style.backgroundColor='transparent'\" title=\"高評価\">\r\n+                    <svg width=\"25\" height=\"25\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n+                      <path d=\"M18.77 11h-4.23l1.52-4.94C16.38 5.03 15.54 4 14.38 4c-.58 0-1.14.24-1.52.65L7 11H3v10h14.43c1.06 0 1.98-.67 2.19-1.61l1.34-6c.27-1.24-.78-2.39-2.19-2.39zM7 20H4v-8h3v8zm12.98-6.83-1.34 6c-.1.48-.61.83-1.21.83H8v-8.61l5.6-6.06c.19-.21.48-.33.78-.33.26 0 .5.11.63.3.07.1.15.26.09.47l-1.52 4.94-.4 1.29h5.58c.41 0 .8.17 1.03.46.13.15.26.4.19.71z\"/>\r\n+                    </svg>\r\n+                    ${comment.likeCount > 0 ? `<span style=\"font-size: 12px; color: #606060;\">${comment.likeCount}</span>` : ''}\r\n+                  </button>\r\n+                  <button style=\"background: none; border: none; border-radius: 18px; padding: 0px; cursor: pointer; display: flex; align-items: center;\" onmouseover=\"this.style.backgroundColor='#f2f2f2'\" onmouseout=\"this.style.backgroundColor='transparent'\">\r\n+                    <svg width=\"25\" height=\"25\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n+                      <path d=\"M17 4H6.57c-1.07 0-1.98.67-2.19 1.61l-1.34 6C2.77 12.85 3.82 14 5.23 14h4.23l-1.52 4.94C7.62 19.97 8.46 21 9.62 21c.58 0 1.14-.24 1.52-.65L17 14h4V4h-4zm-6.6 15.67c-.19.21-.48.33-.78.33-.26 0-.5-.11-.63-.3-.07-.1-.15-.26-.09-.47l1.52-4.94.4-1.29H5.23c-.41 0-.8-.17-1.03-.46-.12-.15-.25-.4-.18-.72l1.34-6c.1-.47.61-.82 1.21-.82H16v8.61l-5.6 6.06zM20 13h-3V5h3v8z\"/>\r\n+                    </svg>\r\n+                  </button>\r\n+                  <button style=\"background: none; border: none; padding: 6px 16px; border-radius: 18px; cursor: pointer; font-size: 12px; font-weight: 500; onmouseover=\"this.style.backgroundColor='#f2f2f2'\" onmouseout=\"this.style.backgroundColor='transparent'\">\r\n+                    返信\r\n+                  </button>\r\n+                </div>\r\n+              </div>\r\n+            </div>\r\n+          `;\r\n+            const commentSection = document.querySelector('#comments #contents');\r\n+            if (commentSection) commentSection.prepend(commentElement);\r\n+          });\r\n+        }\r\n+      }\r\n+    }\r\n+    showResult(resultMsg, true);\r\n+  }\r\n   // 動的ページ対応とMutationObserver\r\n   let lastUrl = location.href;\r\n   let checkInterval;\r\n   let observer;\r\n@@ -265,11 +429,10 @@\n         console.log('ytcmtck: ページ遷移を検出、ボタン再挿入を試行');\r\n         setTimeout(insertAnalyzeButton, 1000);\r\n         setTimeout(insertAnalyzeButton, 3000); // 遅延読み込み対応\r\n       }\r\n-      \r\n-      // ボタンが消えた場合の復旧\r\n-      if (!document.getElementById('ytcmtck-analyze-btn') && findInsertTarget()) {\r\n+        // ボタンが消えた場合の復旧\r\n+      if ((!document.getElementById('ytcmtck-analyze-btn') || !document.getElementById('ytcmtck-simple-analyze-btn')) && findInsertTarget()) {\r\n         console.log('ytcmtck: ボタンが消失、再挿入');\r\n         insertAnalyzeButton();\r\n       }\r\n     }, 2000);\r\n"
                },
                {
                    "date": 1750433291769,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,17 +6,18 @@\n     if (!commentsHeader) return null;\r\n     const additional = commentsHeader.querySelector('#additional-section');\r\n     return additional;\r\n   }\r\n+\r\n   function insertAnalyzeButton() {\r\n     // 既にボタンがある場合は何もしない\r\n-    if (document.getElementById('ytcmtck-analyze-btn') || document.getElementById('ytcmtck-simple-analyze-btn')) return;\r\n+    if (document.getElementById('ytcmtck-analyze-btn')) return;\r\n     \r\n     const additional = findInsertTarget();\r\n     if (!additional) {\r\n       console.log('ytcmtck: #additional-section not found, retrying...');\r\n       return;\r\n-    }      // 通常解析ボタン\r\n+    }\r\n       const btn = document.createElement('button');\r\n     btn.id = 'ytcmtck-analyze-btn';\r\n     btn.textContent = 'コメント解析';\r\n     btn.style.marginLeft = '16px';\r\n@@ -32,34 +33,11 @@\n     btn.style.display = 'flex';\r\n     btn.style.alignItems = 'top';\r\n     btn.style.transition = 'background-color 0.1s ease';\r\n     \r\n-    // 簡易解析ボタン\r\n-    const simpleBtn = document.createElement('button');\r\n-    simpleBtn.id = 'ytcmtck-simple-analyze-btn';\r\n-    simpleBtn.textContent = '簡易解析';\r\n-    simpleBtn.style.marginLeft = '8px';\r\n-    simpleBtn.style.marginTop = '2px';\r\n-    simpleBtn.style.background = 'transparent';\r\n-    simpleBtn.style.color = '#606060';\r\n-    simpleBtn.style.border = '0px';\r\n-    simpleBtn.style.cursor = 'pointer';\r\n-    simpleBtn.style.fontSize = '1.2rem';\r\n-    simpleBtn.style.fontWeight = '400';\r\n-    simpleBtn.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n-    simpleBtn.style.height = '36px';\r\n-    simpleBtn.style.display = 'flex';\r\n-    simpleBtn.style.alignItems = 'top';\r\n-    simpleBtn.style.transition = 'color 0.1s ease';\r\n-    simpleBtn.style.textDecoration = 'none';\r\n-    simpleBtn.addEventListener('mouseenter', () => simpleBtn.style.color = '#0f0f0f');\r\n-    simpleBtn.addEventListener('mouseleave', () => simpleBtn.style.color = '#606060');\r\n-    \r\n     // #additional-section内部の最後に挿入\r\n     additional.appendChild(btn);\r\n-    additional.appendChild(simpleBtn);\r\n     btn.addEventListener('click', onAnalyzeClick);\r\n-    simpleBtn.addEventListener('click', onSimpleAnalyzeClick);\r\n     console.log('ytcmtck: 解析ボタンを挿入しました');\r\n   }\r\n \r\n   // MutationObserverでDOM変更を監視\r\n@@ -270,150 +248,8 @@\n       }\r\n     }\r\n     showResult(resultMsg, true);\r\n   }\r\n-  // 簡易解析（軽量版）\r\n-  async function onSimpleAnalyzeClick() {\r\n-    showResult('簡易解析中...', false);\r\n-    \r\n-    const videoId = getVideoId();\r\n-    if (!videoId) {\r\n-      showResult('エラー: 動画IDが取得できませんでした', true);\r\n-      return;\r\n-    }\r\n-    \r\n-    // 表示中コメント数を取得\r\n-    const ytComments = document.querySelectorAll('#contents #content-text');\r\n-    const ytCount = ytComments.length;\r\n-    \r\n-    // APIで最初の100件のみ取得（簡易版）\r\n-    const apiData = await fetchSimpleComments(videoId);\r\n-    const apiCount = apiData.count;\r\n-    \r\n-    let resultMsg = '簡易解析結果：\\n';\r\n-    resultMsg += `表示中コメント: ${ytCount}件\\n`;\r\n-    resultMsg += `API取得コメント: ${apiCount}件\\n`;\r\n-    \r\n-    if (ytCount === apiCount) {\r\n-      resultMsg += '\\n✅ 表示コメント数とAPI取得数が一致しています';\r\n-    } else if (apiCount > ytCount) {\r\n-      const hiddenCount = apiCount - ytCount;\r\n-      resultMsg += `\\n⚠️ ${hiddenCount}件のコメントが表示されていない可能性があります`;\r\n-      resultMsg += '\\n詳細な解析は「コメント解析」ボタンをお試しください';\r\n-    } else {\r\n-      resultMsg += '\\n📊 表示コメント数の方が多い状態です';\r\n-    }\r\n-    \r\n-    showResult(resultMsg, true);\r\n-  }\r\n-\r\n-  // 簡易版コメント取得（最初の100件のみ）\r\n-  async function fetchSimpleComments(videoId) {\r\n-    if (!videoId) return { count: 0, comments: [] };\r\n-    const apiUrl = `https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${videoId}&key=${YOUTUBE_API_KEY}&maxResults=100`;\r\n-    try {\r\n-      const res = await fetch(apiUrl);\r\n-      const data = await res.json();\r\n-      if (data.error) {\r\n-        console.error('YouTube API Error:', data.error);\r\n-        return { count: 0, comments: [] };\r\n-      }\r\n-      const commentCount = data.items ? data.items.length : 0;\r\n-      return { count: commentCount, comments: [] }; // 簡易版なので詳細データは不要\r\n-    } catch (e) {\r\n-      console.error('API fetch error:', e);\r\n-      return { count: 0, comments: [] };\r\n-    }\r\n-  }\r\n-\r\n-  // 通常解析（詳細版）\r\n-  async function onAnalyzeClick() {\r\n-    showResult('解析中です', false);\r\n-    \r\n-    const videoId = getVideoId();\r\n-    if (!videoId) {\r\n-      showResult('エラー: 動画IDが取得できませんでした', true);\r\n-      return;\r\n-    }\r\n-    \r\n-    const ytComments = document.querySelectorAll('#contents #content-text');\r\n-    const ytCount = ytComments.length;\r\n-    \r\n-    await new Promise(r => setTimeout(r, 1000));\r\n-    const apiData = await fetchComments(videoId);\r\n-    const apiCount = apiData.count;\r\n-    \r\n-    showResult('解析が完了しました。\\nまもなく解析結果が表示されます。', false);\r\n-    await new Promise(r => setTimeout(r, 1000));\r\n-    \r\n-    let resultMsg = '解析結果：\\n';\r\n-    \r\n-    if (ytCount === apiCount) {\r\n-      resultMsg += '全てのコメントが表示されています。';\r\n-    } else {\r\n-      const hiddenCount = Math.max(0, apiCount - ytCount);\r\n-      resultMsg += '表示されていないコメントが見つかったため、コメント欄のトップに表示しました';\r\n-      const hiddenComments = apiData.comments.slice(ytCount);\r\n-      if (hiddenComments.length > 0) {\r\n-        const newHiddenComments = hiddenComments.filter(comment => !displayedCommentIds.has(comment.id));\r\n-        if (newHiddenComments.length > 0) {\r\n-          newHiddenComments.forEach((comment, index) => {\r\n-            displayedCommentIds.add(comment.id);\r\n-            const commentElement = document.createElement('ytd-comment-view-model');\r\n-            commentElement.className = 'style-scope ytd-comment-thread-renderer';\r\n-            commentElement.setAttribute('data-ytcmtck-hidden', 'true');\r\n-            commentElement.style.borderRadius = '8px';\r\n-            commentElement.style.marginBottom = '16px';\r\n-            commentElement.innerHTML = `\r\n-            <div id=\"body\" class=\"style-scope ytd-comment-view-model\">              <div id=\"author-thumbnail\" class=\"style-scope ytd-comment-view-model\">\r\n-                <button id=\"author-thumbnail-button\" class=\"style-scope ytd-comment-view-model\" style=\"border: none; background: none; padding: 0; cursor: pointer;\" aria-label=\"${comment.author}\">\r\n-                  <yt-img-shadow fit=\"\" height=\"40\" width=\"40\" class=\"style-scope ytd-comment-view-model no-transition\" style=\"background-color: transparent;\">\r\n-                    <img style=\"width: 40px; height: 40px; border-radius: 50%; object-fit: cover;\" src=\"${comment.authorProfileImageUrl}\" alt=\"${comment.author}\" onerror=\"this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFNUU3RUIiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNiIgcj0iNiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNMzQgMzJDMzQgMjYuNDc3MiAyOS41MjI4IDIyIDI0IDIySDIwSDEyQzEwLjg5NTQgMjIgMTAgMjIuODk1NCAxMCAyNFYzNEgzNFYzMloiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'\">\r\n-                  </yt-img-shadow>\r\n-                </button>\r\n-              </div>\r\n-              <div id=\"main\" class=\"style-scope ytd-comment-view-model\">\r\n-                <div id=\"header\" class=\"style-scope ytd-comment-view-model\" style=\"display: flex; align-items: center; flex-wrap: wrap; gap: 8px;\">\r\n-                  <h3 class=\"style-scope ytd-comment-view-model\" style=\"margin: 0; font-size: 13px; line-height: 18px; font-weight: 500;\"> \r\n-                    <a class=\"yt-simple-endpoint style-scope ytd-comment-view-model\" href=\"${comment.authorChannelUrl}\" style=\"color: #0f0f0f; text-decoration: none;\">\r\n-                      <span class=\"style-scope ytd-comment-view-model\">${comment.author}</span>\r\n-                    </a>\r\n-                  </h3>\r\n-                  <span dir=\"auto\" style=\"color: #606060; font-size: 12px; line-height: 18px;\">\r\n-                    <a class=\"yt-simple-endpoint style-scope ytd-comment-view-model\" href=\"/watch?v=${getVideoId()}&lc=${comment.id}\" style=\"color: inherit; text-decoration: none;\">\r\n-                      ${formatTimeAgo(comment.publishedAt)}\r\n-                    </a>\r\n-                  </span>\r\n-                </div>\r\n-                <div style=\"margin-top: 2px;\">\r\n-                  <span style=\"color: #0f0f0f; font-size: 14px; line-height: 20px; white-space: pre-wrap;\">${comment.text}</span>\r\n-                </div>                <div style=\"margin-top: 8px; display: flex; align-items: center; gap: 8px;\">\r\n-                  <button style=\"background: none; border: none; padding: 0px; border-radius: 18px; cursor: pointer; display: flex; align-items: center; gap: 6px;\" onmouseover=\"this.style.backgroundColor='#f2f2f2'\" onmouseout=\"this.style.backgroundColor='transparent'\" title=\"高評価\">\r\n-                    <svg width=\"25\" height=\"25\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n-                      <path d=\"M18.77 11h-4.23l1.52-4.94C16.38 5.03 15.54 4 14.38 4c-.58 0-1.14.24-1.52.65L7 11H3v10h14.43c1.06 0 1.98-.67 2.19-1.61l1.34-6c.27-1.24-.78-2.39-2.19-2.39zM7 20H4v-8h3v8zm12.98-6.83-1.34 6c-.1.48-.61.83-1.21.83H8v-8.61l5.6-6.06c.19-.21.48-.33.78-.33.26 0 .5.11.63.3.07.1.15.26.09.47l-1.52 4.94-.4 1.29h5.58c.41 0 .8.17 1.03.46.13.15.26.4.19.71z\"/>\r\n-                    </svg>\r\n-                    ${comment.likeCount > 0 ? `<span style=\"font-size: 12px; color: #606060;\">${comment.likeCount}</span>` : ''}\r\n-                  </button>\r\n-                  <button style=\"background: none; border: none; border-radius: 18px; padding: 0px; cursor: pointer; display: flex; align-items: center;\" onmouseover=\"this.style.backgroundColor='#f2f2f2'\" onmouseout=\"this.style.backgroundColor='transparent'\">\r\n-                    <svg width=\"25\" height=\"25\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n-                      <path d=\"M17 4H6.57c-1.07 0-1.98.67-2.19 1.61l-1.34 6C2.77 12.85 3.82 14 5.23 14h4.23l-1.52 4.94C7.62 19.97 8.46 21 9.62 21c.58 0 1.14-.24 1.52-.65L17 14h4V4h-4zm-6.6 15.67c-.19.21-.48.33-.78.33-.26 0-.5-.11-.63-.3-.07-.1-.15-.26-.09-.47l1.52-4.94.4-1.29H5.23c-.41 0-.8-.17-1.03-.46-.12-.15-.25-.4-.18-.72l1.34-6c.1-.47.61-.82 1.21-.82H16v8.61l-5.6 6.06zM20 13h-3V5h3v8z\"/>\r\n-                    </svg>\r\n-                  </button>\r\n-                  <button style=\"background: none; border: none; padding: 6px 16px; border-radius: 18px; cursor: pointer; font-size: 12px; font-weight: 500; onmouseover=\"this.style.backgroundColor='#f2f2f2'\" onmouseout=\"this.style.backgroundColor='transparent'\">\r\n-                    返信\r\n-                  </button>\r\n-                </div>\r\n-              </div>\r\n-            </div>\r\n-          `;\r\n-            const commentSection = document.querySelector('#comments #contents');\r\n-            if (commentSection) commentSection.prepend(commentElement);\r\n-          });\r\n-        }\r\n-      }\r\n-    }\r\n-    showResult(resultMsg, true);\r\n-  }\r\n   // 動的ページ対応とMutationObserver\r\n   let lastUrl = location.href;\r\n   let checkInterval;\r\n   let observer;\r\n@@ -429,10 +265,11 @@\n         console.log('ytcmtck: ページ遷移を検出、ボタン再挿入を試行');\r\n         setTimeout(insertAnalyzeButton, 1000);\r\n         setTimeout(insertAnalyzeButton, 3000); // 遅延読み込み対応\r\n       }\r\n-        // ボタンが消えた場合の復旧\r\n-      if ((!document.getElementById('ytcmtck-analyze-btn') || !document.getElementById('ytcmtck-simple-analyze-btn')) && findInsertTarget()) {\r\n+      \r\n+      // ボタンが消えた場合の復旧\r\n+      if (!document.getElementById('ytcmtck-analyze-btn') && findInsertTarget()) {\r\n         console.log('ytcmtck: ボタンが消失、再挿入');\r\n         insertAnalyzeButton();\r\n       }\r\n     }, 2000);\r\n"
                },
                {
                    "date": 1750435059468,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,12 +15,11 @@\n     const additional = findInsertTarget();\r\n     if (!additional) {\r\n       console.log('ytcmtck: #additional-section not found, retrying...');\r\n       return;\r\n-    }\r\n-      const btn = document.createElement('button');\r\n+    }      const btn = document.createElement('button');\r\n     btn.id = 'ytcmtck-analyze-btn';\r\n-    btn.textContent = 'コメント解析';\r\n+    btn.textContent = '🔍コメント解析';\r\n     btn.style.marginLeft = '16px';\r\n     btn.style.marginTop = '2px';\r\n     btn.style.background = 'transparent';\r\n     btn.style.color = '#0f0f0f';\r\n"
                },
                {
                    "date": 1750435297596,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,10 +15,9 @@\n     const additional = findInsertTarget();\r\n     if (!additional) {\r\n       console.log('ytcmtck: #additional-section not found, retrying...');\r\n       return;\r\n-    }      const btn = document.createElement('button');\r\n-    btn.id = 'ytcmtck-analyze-btn';\r\n+    }      const btn = document.createElement('button');    btn.id = 'ytcmtck-analyze-btn';\r\n     btn.textContent = '🔍コメント解析';\r\n     btn.style.marginLeft = '16px';\r\n     btn.style.marginTop = '2px';\r\n     btn.style.background = 'transparent';\r\n@@ -31,12 +30,44 @@\n     btn.style.height = '36px';\r\n     btn.style.display = 'flex';\r\n     btn.style.alignItems = 'top';\r\n     btn.style.transition = 'background-color 0.1s ease';\r\n-    \r\n-    // #additional-section内部の最後に挿入\r\n+      // #additional-section内部の最後に挿入\r\n     additional.appendChild(btn);\r\n     btn.addEventListener('click', onAnalyzeClick);\r\n+    \r\n+    // 設定ボタンを追加\r\n+    const settingsBtn = document.createElement('button');\r\n+    settingsBtn.id = 'ytcmtck-settings-btn';\r\n+    settingsBtn.textContent = '⚙️';\r\n+    settingsBtn.style.marginLeft = '8px';\r\n+    settingsBtn.style.marginTop = '2px';\r\n+    settingsBtn.style.background = 'transparent';\r\n+    settingsBtn.style.color = '#0f0f0f';\r\n+    settingsBtn.style.border = '0px';\r\n+    settingsBtn.style.cursor = 'pointer';\r\n+    settingsBtn.style.fontSize = '1.4rem';\r\n+    settingsBtn.style.fontWeight = '500';\r\n+    settingsBtn.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n+    settingsBtn.style.height = '36px';\r\n+    settingsBtn.style.display = 'flex';\r\n+    settingsBtn.style.alignItems = 'center';\r\n+    settingsBtn.style.justifyContent = 'center';\r\n+    settingsBtn.style.width = '36px';\r\n+    settingsBtn.style.borderRadius = '50%';\r\n+    settingsBtn.style.transition = 'background-color 0.1s ease';\r\n+    settingsBtn.title = '設定';\r\n+    \r\n+    settingsBtn.addEventListener('mouseenter', () => {\r\n+      settingsBtn.style.backgroundColor = '#f2f2f2';\r\n+    });\r\n+    settingsBtn.addEventListener('mouseleave', () => {\r\n+      settingsBtn.style.backgroundColor = 'transparent';\r\n+    });\r\n+    \r\n+    additional.appendChild(settingsBtn);\r\n+    settingsBtn.addEventListener('click', showSettingsModal);\r\n+    \r\n     console.log('ytcmtck: 解析ボタンを挿入しました');\r\n   }\r\n \r\n   // MutationObserverでDOM変更を監視\r\n@@ -97,12 +128,184 @@\n         }\r\n       }, 5000);\r\n     }\r\n   }\r\n-\r\n   // ★APIキーをここに設定（ご自身のYouTube Data APIキーに差し替えてください）\r\n   const YOUTUBE_API_KEY = 'AIzaSyCB9iLVqz1AsLrYk83tILnILa7n6OzfEkg';\r\n \r\n+  // 設定のデフォルト値\r\n+  let settings = {\r\n+    showUsernames: true,\r\n+    showComments: true\r\n+  };\r\n+\r\n+  // 設定を読み込み\r\n+  function loadSettings() {\r\n+    const saved = localStorage.getItem('ytcmtck-settings');\r\n+    if (saved) {\r\n+      try {\r\n+        settings = { ...settings, ...JSON.parse(saved) };\r\n+      } catch (e) {\r\n+        console.error('設定の読み込みに失敗:', e);\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  // 設定を保存\r\n+  function saveSettings() {\r\n+    localStorage.setItem('ytcmtck-settings', JSON.stringify(settings));\r\n+  }\r\n+\r\n+  // iPhone風スイッチを作成\r\n+  function createToggleSwitch(isOn, onChange) {\r\n+    const switchContainer = document.createElement('div');\r\n+    switchContainer.style.position = 'relative';\r\n+    switchContainer.style.width = '50px';\r\n+    switchContainer.style.height = '30px';\r\n+    switchContainer.style.backgroundColor = isOn ? '#007AFF' : '#E5E5EA';\r\n+    switchContainer.style.borderRadius = '15px';\r\n+    switchContainer.style.cursor = 'pointer';\r\n+    switchContainer.style.transition = 'background-color 0.3s ease';\r\n+    \r\n+    const switchButton = document.createElement('div');\r\n+    switchButton.style.position = 'absolute';\r\n+    switchButton.style.top = '2px';\r\n+    switchButton.style.left = isOn ? '22px' : '2px';\r\n+    switchButton.style.width = '26px';\r\n+    switchButton.style.height = '26px';\r\n+    switchButton.style.backgroundColor = '#FFFFFF';\r\n+    switchButton.style.borderRadius = '50%';\r\n+    switchButton.style.transition = 'left 0.3s ease';\r\n+    switchButton.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.2)';\r\n+    \r\n+    switchContainer.appendChild(switchButton);\r\n+    \r\n+    switchContainer.addEventListener('click', () => {\r\n+      const newState = !isOn;\r\n+      isOn = newState;\r\n+      switchContainer.style.backgroundColor = newState ? '#007AFF' : '#E5E5EA';\r\n+      switchButton.style.left = newState ? '22px' : '2px';\r\n+      onChange(newState);\r\n+    });\r\n+    \r\n+    return switchContainer;\r\n+  }\r\n+\r\n+  // 設定モーダルを表示\r\n+  function showSettingsModal() {\r\n+    // 既存のモーダルがある場合は削除\r\n+    const existingModal = document.getElementById('ytcmtck-settings-modal');\r\n+    if (existingModal) {\r\n+      existingModal.remove();\r\n+    }\r\n+\r\n+    const modal = document.createElement('div');\r\n+    modal.id = 'ytcmtck-settings-modal';\r\n+    modal.style.position = 'fixed';\r\n+    modal.style.top = '0';\r\n+    modal.style.left = '0';\r\n+    modal.style.width = '100%';\r\n+    modal.style.height = '100%';\r\n+    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';\r\n+    modal.style.zIndex = '10000';\r\n+    modal.style.display = 'flex';\r\n+    modal.style.justifyContent = 'center';\r\n+    modal.style.alignItems = 'center';\r\n+\r\n+    const modalContent = document.createElement('div');\r\n+    modalContent.style.backgroundColor = '#ffffff';\r\n+    modalContent.style.borderRadius = '12px';\r\n+    modalContent.style.padding = '24px';\r\n+    modalContent.style.minWidth = '320px';\r\n+    modalContent.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.2)';\r\n+    modalContent.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n+\r\n+    const title = document.createElement('h2');\r\n+    title.textContent = 'コメント解析 設定';\r\n+    title.style.margin = '0 0 24px 0';\r\n+    title.style.fontSize = '20px';\r\n+    title.style.fontWeight = '600';\r\n+    title.style.color = '#0f0f0f';\r\n+    modalContent.appendChild(title);\r\n+\r\n+    // ユーザー名表示設定\r\n+    const usernameRow = document.createElement('div');\r\n+    usernameRow.style.display = 'flex';\r\n+    usernameRow.style.justifyContent = 'space-between';\r\n+    usernameRow.style.alignItems = 'center';\r\n+    usernameRow.style.marginBottom = '20px';\r\n+    \r\n+    const usernameLabel = document.createElement('span');\r\n+    usernameLabel.textContent = 'ユーザー名を表示';\r\n+    usernameLabel.style.fontSize = '16px';\r\n+    usernameLabel.style.color = '#0f0f0f';\r\n+    usernameRow.appendChild(usernameLabel);\r\n+\r\n+    const usernameSwitch = createToggleSwitch(settings.showUsernames, (value) => {\r\n+      settings.showUsernames = value;\r\n+      saveSettings();\r\n+    });\r\n+    usernameRow.appendChild(usernameSwitch);\r\n+    modalContent.appendChild(usernameRow);\r\n+\r\n+    // コメント表示設定\r\n+    const commentRow = document.createElement('div');\r\n+    commentRow.style.display = 'flex';\r\n+    commentRow.style.justifyContent = 'space-between';\r\n+    commentRow.style.alignItems = 'center';\r\n+    commentRow.style.marginBottom = '32px';\r\n+    \r\n+    const commentLabel = document.createElement('span');\r\n+    commentLabel.textContent = 'コメントを表示';\r\n+    commentLabel.style.fontSize = '16px';\r\n+    commentLabel.style.color = '#0f0f0f';\r\n+    commentRow.appendChild(commentLabel);\r\n+\r\n+    const commentSwitch = createToggleSwitch(settings.showComments, (value) => {\r\n+      settings.showComments = value;\r\n+      saveSettings();\r\n+    });\r\n+    commentRow.appendChild(commentSwitch);\r\n+    modalContent.appendChild(commentRow);\r\n+\r\n+    // 閉じるボタン\r\n+    const closeButton = document.createElement('button');\r\n+    closeButton.textContent = '閉じる';\r\n+    closeButton.style.width = '100%';\r\n+    closeButton.style.padding = '12px';\r\n+    closeButton.style.backgroundColor = '#007AFF';\r\n+    closeButton.style.color = '#ffffff';\r\n+    closeButton.style.border = 'none';\r\n+    closeButton.style.borderRadius = '8px';\r\n+    closeButton.style.fontSize = '16px';\r\n+    closeButton.style.fontWeight = '600';\r\n+    closeButton.style.cursor = 'pointer';\r\n+    closeButton.style.transition = 'background-color 0.2s ease';\r\n+    \r\n+    closeButton.addEventListener('mouseenter', () => {\r\n+      closeButton.style.backgroundColor = '#0056CC';\r\n+    });\r\n+    closeButton.addEventListener('mouseleave', () => {\r\n+      closeButton.style.backgroundColor = '#007AFF';\r\n+    });\r\n+    \r\n+    closeButton.addEventListener('click', () => {\r\n+      modal.remove();\r\n+    });\r\n+    modalContent.appendChild(closeButton);\r\n+\r\n+    modal.appendChild(modalContent);\r\n+    \r\n+    // モーダル外をクリックしたら閉じる\r\n+    modal.addEventListener('click', (e) => {\r\n+      if (e.target === modal) {\r\n+        modal.remove();\r\n+      }\r\n+    });\r\n+\r\n+    document.body.appendChild(modal);\r\n+  }\r\n+\r\n   // 動画IDをURLから取得\r\n   function getVideoId() {\r\n     const url = new URL(location.href);\r\n     return url.searchParams.get('v');\r\n@@ -205,24 +408,23 @@\n                     <img style=\"width: 40px; height: 40px; border-radius: 50%; object-fit: cover;\" src=\"${comment.authorProfileImageUrl}\" alt=\"${comment.author}\" onerror=\"this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFNUU3RUIiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNiIgcj0iNiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNMzQgMzJDMzQgMjYuNDc3MiAyOS41MjI4IDIyIDI0IDIySDIwSDEyQzEwLjg5NTQgMjIgMTAgMjIuODk1NCAxMCAyNFYzNEgzNFYzMloiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'\">\r\n                   </yt-img-shadow>\r\n                 </button>\r\n               </div>\r\n-              <div id=\"main\" class=\"style-scope ytd-comment-view-model\">\r\n-                <div id=\"header\" class=\"style-scope ytd-comment-view-model\" style=\"display: flex; align-items: center; flex-wrap: wrap; gap: 8px;\">\r\n-                  <h3 class=\"style-scope ytd-comment-view-model\" style=\"margin: 0; font-size: 13px; line-height: 18px; font-weight: 500;\"> \r\n+              <div id=\"main\" class=\"style-scope ytd-comment-view-model\">                <div id=\"header\" class=\"style-scope ytd-comment-view-model\" style=\"display: flex; align-items: center; flex-wrap: wrap; gap: 8px;\">\r\n+                  ${settings.showUsernames ? `<h3 class=\"style-scope ytd-comment-view-model\" style=\"margin: 0; font-size: 13px; line-height: 18px; font-weight: 500;\"> \r\n                     <a class=\"yt-simple-endpoint style-scope ytd-comment-view-model\" href=\"${comment.authorChannelUrl}\" style=\"color: #0f0f0f; text-decoration: none;\">\r\n                       <span class=\"style-scope ytd-comment-view-model\">${comment.author}</span>\r\n                     </a>\r\n-                  </h3>\r\n+                  </h3>` : ''}\r\n                   <span dir=\"auto\" style=\"color: #606060; font-size: 12px; line-height: 18px;\">\r\n                     <a class=\"yt-simple-endpoint style-scope ytd-comment-view-model\" href=\"/watch?v=${getVideoId()}&lc=${comment.id}\" style=\"color: inherit; text-decoration: none;\">\r\n                       ${formatTimeAgo(comment.publishedAt)}\r\n                     </a>\r\n                   </span>\r\n                 </div>\r\n-                <div style=\"margin-top: 2px;\">\r\n+                ${settings.showComments ? `<div style=\"margin-top: 2px;\">\r\n                   <span style=\"color: #0f0f0f; font-size: 14px; line-height: 20px; white-space: pre-wrap;\">${comment.text}</span>\r\n-                </div>                <div style=\"margin-top: 8px; display: flex; align-items: center; gap: 8px;\">\r\n+                </div>` : ''}<div style=\"margin-top: 8px; display: flex; align-items: center; gap: 8px;\">\r\n                   <button style=\"background: none; border: none; padding: 0px; border-radius: 18px; cursor: pointer; display: flex; align-items: center; gap: 6px;\" onmouseover=\"this.style.backgroundColor='#f2f2f2'\" onmouseout=\"this.style.backgroundColor='transparent'\" title=\"高評価\">\r\n                     <svg width=\"25\" height=\"25\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n                       <path d=\"M18.77 11h-4.23l1.52-4.94C16.38 5.03 15.54 4 14.38 4c-.58 0-1.14.24-1.52.65L7 11H3v10h14.43c1.06 0 1.98-.67 2.19-1.61l1.34-6c.27-1.24-.78-2.39-2.19-2.39zM7 20H4v-8h3v8zm12.98-6.83-1.34 6c-.1.48-.61.83-1.21.83H8v-8.61l5.6-6.06c.19-.21.48-.33.78-.33.26 0 .5.11.63.3.07.1.15.26.09.47l-1.52 4.94-.4 1.29h5.58c.41 0 .8.17 1.03.46.13.15.26.4.19.71z\"/>\r\n                     </svg>\r\n@@ -264,10 +466,9 @@\n         console.log('ytcmtck: ページ遷移を検出、ボタン再挿入を試行');\r\n         setTimeout(insertAnalyzeButton, 1000);\r\n         setTimeout(insertAnalyzeButton, 3000); // 遅延読み込み対応\r\n       }\r\n-      \r\n-      // ボタンが消えた場合の復旧\r\n+        // ボタンが消えた場合の復旧\r\n       if (!document.getElementById('ytcmtck-analyze-btn') && findInsertTarget()) {\r\n         console.log('ytcmtck: ボタンが消失、再挿入');\r\n         insertAnalyzeButton();\r\n       }\r\n@@ -275,8 +476,11 @@\n   }\r\n \r\n   // 初期化\r\n   function init() {\r\n+    // 設定を読み込み\r\n+    loadSettings();\r\n+    \r\n     // 複数回試行で確実に挿入\r\n     setTimeout(insertAnalyzeButton, 1000);\r\n     setTimeout(insertAnalyzeButton, 3000);\r\n     setTimeout(insertAnalyzeButton, 5000);\r\n"
                },
                {
                    "date": 1750436494343,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -103,24 +103,22 @@\n   }  function showResult(message, isFinal) {\r\n     let result = document.getElementById('ytcmtck-analyze-result');\r\n     if (!result) {\r\n       result = document.createElement('div');\r\n-      result.id = 'ytcmtck-analyze-result';\r\n-      result.style.margin = '16px 0';\r\n+      result.id = 'ytcmtck-analyze-result';      result.style.margin = '16px 0';\r\n       result.style.padding = '16px';\r\n-      result.style.background = '#f9f9f9';\r\n+      result.style.background = settings.useCustomBackground ? settings.backgroundColor : '#f9f9f9';\r\n       result.style.border = '1px solid #ddd';\r\n       result.style.borderRadius = '8px';\r\n       result.style.fontSize = '16px';\r\n       result.style.lineHeight = '1.5';\r\n       result.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n       result.style.whiteSpace = 'pre-line';\r\n       const commentSection = document.querySelector('#comments');\r\n       if (commentSection) commentSection.prepend(result);\r\n-    }\r\n-    result.textContent = message;\r\n+    }    result.textContent = message;\r\n     if (isFinal) {\r\n-      result.style.background = '#e6ffe6';\r\n+      result.style.background = settings.useCustomBackground ? settings.backgroundColor : '#e6ffe6';\r\n       result.style.fontWeight = '500';\r\n       // 5秒後に自動で削除\r\n       setTimeout(() => {\r\n         if (result && result.parentNode) {\r\n@@ -129,16 +127,20 @@\n       }, 5000);\r\n     }\r\n   }\r\n   // ★APIキーをここに設定（ご自身のYouTube Data APIキーに差し替えてください）\r\n-  const YOUTUBE_API_KEY = 'AIzaSyCB9iLVqz1AsLrYk83tILnILa7n6OzfEkg';\r\n-\r\n-  // 設定のデフォルト値\r\n+  const YOUTUBE_API_KEY = 'AIzaSyCB9iLVqz1AsLrYk83tILnILa7n6OzfEkg';  // 設定のデフォルト値\r\n   let settings = {\r\n     showUsernames: true,\r\n-    showComments: true\r\n+    showComments: true,\r\n+    useCustomBackground: false,\r\n+    backgroundColor: '#f9f9f9'\r\n   };\r\n \r\n+  // 検索結果を格納する変数\r\n+  let allComments = [];\r\n+  let searchResultsContainer = null;\r\n+\r\n   // 設定を読み込み\r\n   function loadSettings() {\r\n     const saved = localStorage.getItem('ytcmtck-settings');\r\n     if (saved) {\r\n@@ -153,9 +155,8 @@\n   // 設定を保存\r\n   function saveSettings() {\r\n     localStorage.setItem('ytcmtck-settings', JSON.stringify(settings));\r\n   }\r\n-\r\n   // iPhone風スイッチを作成\r\n   function createToggleSwitch(isOn, onChange) {\r\n     const switchContainer = document.createElement('div');\r\n     switchContainer.style.position = 'relative';\r\n@@ -189,8 +190,269 @@\n     \r\n     return switchContainer;\r\n   }\r\n \r\n+  // カラーサークルピッカーを作成\r\n+  function createColorPicker(selectedColor, onChange) {\r\n+    const colors = [\r\n+      '#f9f9f9', '#e6ffe6', '#ffe6e6', '#e6f3ff', '#fff2e6',\r\n+      '#f0e6ff', '#ffe6f9', '#e6fff9', '#ffffe6', '#f5f5f5',\r\n+      '#d1ecf1', '#f8d7da', '#d4edda', '#fff3cd', '#e2e3e5'\r\n+    ];\r\n+\r\n+    const container = document.createElement('div');\r\n+    container.style.display = 'grid';\r\n+    container.style.gridTemplateColumns = 'repeat(5, 1fr)';\r\n+    container.style.gap = '8px';\r\n+    container.style.marginTop = '8px';\r\n+\r\n+    colors.forEach(color => {\r\n+      const colorCircle = document.createElement('div');\r\n+      colorCircle.style.width = '32px';\r\n+      colorCircle.style.height = '32px';\r\n+      colorCircle.style.backgroundColor = color;\r\n+      colorCircle.style.borderRadius = '50%';\r\n+      colorCircle.style.cursor = 'pointer';\r\n+      colorCircle.style.border = selectedColor === color ? '3px solid #007AFF' : '2px solid #ddd';\r\n+      colorCircle.style.transition = 'all 0.2s ease';\r\n+      colorCircle.style.boxSizing = 'border-box';\r\n+\r\n+      colorCircle.addEventListener('click', () => {\r\n+        // 他の全ての色円の選択状態をリセット\r\n+        container.querySelectorAll('div').forEach(circle => {\r\n+          circle.style.border = '2px solid #ddd';\r\n+        });\r\n+        // 選択した色円をハイライト\r\n+        colorCircle.style.border = '3px solid #007AFF';\r\n+        onChange(color);\r\n+      });\r\n+\r\n+      container.appendChild(colorCircle);\r\n+    });    return container;\r\n+  }  // ユーザーID検索ボックスを作成\r\n+  function createUserSearchBox() {\r\n+    // 既存の検索ボックスがある場合は削除\r\n+    const existingSearch = document.getElementById('ytcmtck-user-search');\r\n+    if (existingSearch) {\r\n+      existingSearch.remove();\r\n+    }\r\n+\r\n+    // #contentsを探す\r\n+    const contentsElement = document.querySelector('#contents.style-scope.ytd-item-section-renderer');\r\n+    if (!contentsElement) {\r\n+      console.log('ytcmtck: #contents が見つかりません');\r\n+      return;\r\n+    }\r\n+\r\n+    // 検索ボックスコンテナを作成\r\n+    const searchContainer = document.createElement('div');\r\n+    searchContainer.id = 'ytcmtck-user-search';\r\n+    searchContainer.style.margin = '16px 0';\r\n+    searchContainer.style.padding = '16px';\r\n+    searchContainer.style.backgroundColor = '#f8f9fa';\r\n+    searchContainer.style.borderRadius = '8px';\r\n+    searchContainer.style.border = '1px solid #e1e5e9';\r\n+    searchContainer.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n+\r\n+    // タイトル\r\n+    const searchTitle = document.createElement('h4');\r\n+    searchTitle.textContent = 'ユーザーID検索';\r\n+    searchTitle.style.margin = '0 0 12px 0';\r\n+    searchTitle.style.fontSize = '14px';\r\n+    searchTitle.style.fontWeight = '500';\r\n+    searchTitle.style.color = '#0f0f0f';\r\n+    searchContainer.appendChild(searchTitle);\r\n+\r\n+    // 検索入力欄\r\n+    const searchInputContainer = document.createElement('div');\r\n+    searchInputContainer.style.display = 'flex';\r\n+    searchInputContainer.style.gap = '8px';\r\n+    searchInputContainer.style.marginBottom = '12px';\r\n+\r\n+    const searchInput = document.createElement('input');\r\n+    searchInput.type = 'text';\r\n+    searchInput.placeholder = '@ユーザーID を入力';\r\n+    searchInput.style.flex = '1';\r\n+    searchInput.style.padding = '8px 12px';\r\n+    searchInput.style.border = '1px solid #ccc';\r\n+    searchInput.style.borderRadius = '20px';\r\n+    searchInput.style.fontSize = '14px';\r\n+    searchInput.style.outline = 'none';\r\n+    searchInput.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n+\r\n+    const searchButton = document.createElement('button');\r\n+    searchButton.textContent = '🔍';\r\n+    searchButton.style.padding = '8px 16px';\r\n+    searchButton.style.border = 'none';\r\n+    searchButton.style.borderRadius = '20px';\r\n+    searchButton.style.backgroundColor = '#007AFF';\r\n+    searchButton.style.color = '#ffffff';\r\n+    searchButton.style.cursor = 'pointer';\r\n+    searchButton.style.fontSize = '14px';\r\n+    searchButton.style.transition = 'background-color 0.2s ease';\r\n+\r\n+    searchButton.addEventListener('mouseenter', () => {\r\n+      searchButton.style.backgroundColor = '#0056CC';\r\n+    });\r\n+    searchButton.addEventListener('mouseleave', () => {\r\n+      searchButton.style.backgroundColor = '#007AFF';\r\n+    });\r\n+\r\n+    searchInputContainer.appendChild(searchInput);\r\n+    searchInputContainer.appendChild(searchButton);\r\n+    searchContainer.appendChild(searchInputContainer);\r\n+\r\n+    // 検索結果表示エリア\r\n+    searchResultsContainer = document.createElement('div');\r\n+    searchResultsContainer.id = 'ytcmtck-search-results';\r\n+    searchResultsContainer.style.display = 'none';\r\n+    searchContainer.appendChild(searchResultsContainer);\r\n+\r\n+    // 検索機能\r\n+    const performSearch = () => {\r\n+      const query = searchInput.value.trim();\r\n+      if (!query) {\r\n+        searchResultsContainer.style.display = 'none';\r\n+        return;\r\n+      }\r\n+\r\n+      // @を自動追加\r\n+      const searchQuery = query.startsWith('@') ? query : '@' + query;\r\n+      const results = allComments.filter(comment => \r\n+        comment.author.toLowerCase().includes(searchQuery.toLowerCase().substring(1))\r\n+      );\r\n+\r\n+      displaySearchResults(results, searchQuery);\r\n+    };\r\n+\r\n+    // イベントリスナー\r\n+    searchButton.addEventListener('click', performSearch);\r\n+    searchInput.addEventListener('keypress', (e) => {\r\n+      if (e.key === 'Enter') {\r\n+        performSearch();\r\n+      }\r\n+    });\r\n+    searchInput.addEventListener('input', () => {\r\n+      if (searchInput.value.trim() === '') {\r\n+        searchResultsContainer.style.display = 'none';\r\n+      }\r\n+    });\r\n+\r\n+    // #contentsの直前に挿入\r\n+    contentsElement.parentNode.insertBefore(searchContainer, contentsElement);\r\n+    \r\n+    console.log('ytcmtck: ユーザー検索ボックスを追加しました');\r\n+  }\r\n+\r\n+  // 検索結果を表示\r\n+  function displaySearchResults(results, query) {\r\n+    if (!searchResultsContainer) return;\r\n+\r\n+    searchResultsContainer.innerHTML = '';\r\n+    searchResultsContainer.style.display = 'block';\r\n+\r\n+    if (results.length === 0) {\r\n+      const noResults = document.createElement('div');\r\n+      noResults.textContent = `\"${query}\" に一致するユーザーが見つかりませんでした`;\r\n+      noResults.style.padding = '12px';\r\n+      noResults.style.color = '#666';\r\n+      noResults.style.fontSize = '14px';\r\n+      noResults.style.textAlign = 'center';\r\n+      searchResultsContainer.appendChild(noResults);\r\n+      return;\r\n+    }\r\n+\r\n+    const resultHeader = document.createElement('div');\r\n+    resultHeader.textContent = `\"${query}\" の検索結果 (${results.length}件)`;\r\n+    resultHeader.style.fontSize = '14px';\r\n+    resultHeader.style.fontWeight = '500';\r\n+    resultHeader.style.marginBottom = '12px';\r\n+    resultHeader.style.color = '#0f0f0f';\r\n+    searchResultsContainer.appendChild(resultHeader);\r\n+\r\n+    const resultsList = document.createElement('div');\r\n+    resultsList.style.maxHeight = '300px';\r\n+    resultsList.style.overflowY = 'auto';\r\n+    resultsList.style.border = '1px solid #e1e5e9';\r\n+    resultsList.style.borderRadius = '8px';\r\n+    resultsList.style.backgroundColor = '#ffffff';\r\n+\r\n+    results.forEach((comment, index) => {\r\n+      const resultItem = document.createElement('div');\r\n+      resultItem.style.padding = '12px';\r\n+      resultItem.style.borderBottom = index < results.length - 1 ? '1px solid #f0f0f0' : 'none';\r\n+      resultItem.style.cursor = 'pointer';\r\n+      resultItem.style.transition = 'background-color 0.2s ease';\r\n+\r\n+      resultItem.addEventListener('mouseenter', () => {\r\n+        resultItem.style.backgroundColor = '#f8f9fa';\r\n+      });\r\n+      resultItem.addEventListener('mouseleave', () => {\r\n+        resultItem.style.backgroundColor = '#ffffff';\r\n+      });\r\n+\r\n+      const authorInfo = document.createElement('div');\r\n+      authorInfo.style.display = 'flex';\r\n+      authorInfo.style.alignItems = 'center';\r\n+      authorInfo.style.marginBottom = '8px';\r\n+\r\n+      const authorImage = document.createElement('img');\r\n+      authorImage.src = comment.authorProfileImageUrl;\r\n+      authorImage.style.width = '24px';\r\n+      authorImage.style.height = '24px';\r\n+      authorImage.style.borderRadius = '50%';\r\n+      authorImage.style.marginRight = '8px';\r\n+      authorImage.onerror = () => {\r\n+        authorImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTIiIGZpbGw9IiNFNUU3RUIiLz4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMCIgcj0iNCIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNMjAgMTkuMkMyMCAxNi4wODU3IDE2LjQxODMgMTMuNiAxMiAxMy42QzcuNTgxNzEgMTMuNiA0IDE2LjA4NTcgNCAzNy4yVjIwSDIwVjE5LjJaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPg==';\r\n+      };\r\n+\r\n+      const authorName = document.createElement('span');\r\n+      authorName.textContent = comment.author;\r\n+      authorName.style.fontSize = '14px';\r\n+      authorName.style.fontWeight = '500';\r\n+      authorName.style.color = '#0f0f0f';\r\n+\r\n+      const timeAgo = document.createElement('span');\r\n+      timeAgo.textContent = ` • ${formatTimeAgo(comment.publishedAt)}`;\r\n+      timeAgo.style.fontSize = '12px';\r\n+      timeAgo.style.color = '#606060';\r\n+\r\n+      authorInfo.appendChild(authorImage);\r\n+      authorInfo.appendChild(authorName);\r\n+      authorInfo.appendChild(timeAgo);\r\n+\r\n+      const commentText = document.createElement('div');\r\n+      commentText.textContent = comment.text.length > 100 ? comment.text.substring(0, 100) + '...' : comment.text;\r\n+      commentText.style.fontSize = '14px';\r\n+      commentText.style.color = '#0f0f0f';\r\n+      commentText.style.lineHeight = '1.4';\r\n+\r\n+      resultItem.appendChild(authorInfo);\r\n+      resultItem.appendChild(commentText);\r\n+\r\n+      // クリックでコメントにスクロール\r\n+      resultItem.addEventListener('click', () => {\r\n+        const commentElement = document.querySelector(`[data-ytcmtck-hidden=\"true\"] a[href*=\"lc=${comment.id}\"]`);\r\n+        if (commentElement) {\r\n+          commentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });\r\n+          // ハイライト効果\r\n+          const highlightElement = commentElement.closest('[data-ytcmtck-hidden=\"true\"]');\r\n+          if (highlightElement) {\r\n+            const originalBackground = highlightElement.style.backgroundColor;\r\n+            highlightElement.style.backgroundColor = '#fff3cd';\r\n+            setTimeout(() => {\r\n+              highlightElement.style.backgroundColor = originalBackground;\r\n+            }, 2000);\r\n+          }\r\n+        }\r\n+      });\r\n+\r\n+      resultsList.appendChild(resultItem);\r\n+    });\r\n+\r\n+    searchResultsContainer.appendChild(resultsList);\r\n+  }\r\n+\r\n   // 設定モーダルを表示\r\n   function showSettingsModal() {\r\n     // 既存のモーダルがある場合は削除\r\n     const existingModal = document.getElementById('ytcmtck-settings-modal');\r\n@@ -262,12 +524,52 @@\n \r\n     const commentSwitch = createToggleSwitch(settings.showComments, (value) => {\r\n       settings.showComments = value;\r\n       saveSettings();\r\n-    });\r\n-    commentRow.appendChild(commentSwitch);\r\n+    });    commentRow.appendChild(commentSwitch);\r\n     modalContent.appendChild(commentRow);\r\n \r\n+    // 背景色カスタマイズ設定\r\n+    const backgroundRow = document.createElement('div');\r\n+    backgroundRow.style.display = 'flex';\r\n+    backgroundRow.style.justifyContent = 'space-between';\r\n+    backgroundRow.style.alignItems = 'center';\r\n+    backgroundRow.style.marginBottom = '16px';\r\n+    \r\n+    const backgroundLabel = document.createElement('span');\r\n+    backgroundLabel.textContent = '背景色をカスタマイズ';\r\n+    backgroundLabel.style.fontSize = '16px';\r\n+    backgroundLabel.style.color = '#0f0f0f';\r\n+    backgroundRow.appendChild(backgroundLabel);\r\n+\r\n+    const backgroundSwitch = createToggleSwitch(settings.useCustomBackground, (value) => {\r\n+      settings.useCustomBackground = value;\r\n+      saveSettings();\r\n+      // 色選択部分の表示/非表示を切り替え\r\n+      colorPickerSection.style.display = value ? 'block' : 'none';\r\n+    });\r\n+    backgroundRow.appendChild(backgroundSwitch);\r\n+    modalContent.appendChild(backgroundRow);\r\n+\r\n+    // 色選択部分\r\n+    const colorPickerSection = document.createElement('div');\r\n+    colorPickerSection.style.display = settings.useCustomBackground ? 'block' : 'none';\r\n+    colorPickerSection.style.marginBottom = '32px';\r\n+\r\n+    const colorLabel = document.createElement('div');\r\n+    colorLabel.textContent = '背景色を選択';\r\n+    colorLabel.style.fontSize = '14px';\r\n+    colorLabel.style.color = '#666';\r\n+    colorLabel.style.marginBottom = '8px';\r\n+    colorPickerSection.appendChild(colorLabel);\r\n+\r\n+    const colorPicker = createColorPicker(settings.backgroundColor, (color) => {\r\n+      settings.backgroundColor = color;\r\n+      saveSettings();\r\n+    });\r\n+    colorPickerSection.appendChild(colorPicker);\r\n+    modalContent.appendChild(colorPickerSection);\r\n+\r\n     // 閉じるボタン\r\n     const closeButton = document.createElement('button');\r\n     closeButton.textContent = '閉じる';\r\n     closeButton.style.width = '100%';\r\n@@ -374,13 +676,15 @@\n     }\r\n     \r\n     const ytComments = document.querySelectorAll('#contents #content-text');\r\n     const ytCount = ytComments.length;\r\n-    \r\n-    await new Promise(r => setTimeout(r, 1000));\r\n+      await new Promise(r => setTimeout(r, 1000));\r\n     const apiData = await fetchComments(videoId);\r\n     const apiCount = apiData.count;\r\n     \r\n+    // 全コメントを保存（検索用）\r\n+    allComments = apiData.comments;\r\n+    \r\n     showResult('解析が完了しました。\\nまもなく解析結果が表示されます。', false);\r\n     await new Promise(r => setTimeout(r, 1000));\r\n     \r\n     let resultMsg = '解析結果：\\n';\r\n@@ -395,13 +699,14 @@\n         const newHiddenComments = hiddenComments.filter(comment => !displayedCommentIds.has(comment.id));\r\n         if (newHiddenComments.length > 0) {\r\n           newHiddenComments.forEach((comment, index) => {\r\n             displayedCommentIds.add(comment.id);\r\n-            const commentElement = document.createElement('ytd-comment-view-model');\r\n-            commentElement.className = 'style-scope ytd-comment-thread-renderer';\r\n+            const commentElement = document.createElement('ytd-comment-view-model');            commentElement.className = 'style-scope ytd-comment-thread-renderer';\r\n             commentElement.setAttribute('data-ytcmtck-hidden', 'true');\r\n             commentElement.style.borderRadius = '8px';\r\n             commentElement.style.marginBottom = '16px';\r\n+            commentElement.style.backgroundColor = settings.useCustomBackground ? settings.backgroundColor : 'transparent';\r\n+            commentElement.style.padding = settings.useCustomBackground ? '12px' : '0';\r\n             commentElement.innerHTML = `\r\n             <div id=\"body\" class=\"style-scope ytd-comment-view-model\">              <div id=\"author-thumbnail\" class=\"style-scope ytd-comment-view-model\">\r\n                 <button id=\"author-thumbnail-button\" class=\"style-scope ytd-comment-view-model\" style=\"border: none; background: none; padding: 0; cursor: pointer;\" aria-label=\"${comment.author}\">\r\n                   <yt-img-shadow fit=\"\" height=\"40\" width=\"40\" class=\"style-scope ytd-comment-view-model no-transition\" style=\"background-color: transparent;\">\r\n@@ -443,13 +748,15 @@\n             </div>\r\n           `;\r\n             const commentSection = document.querySelector('#comments #contents');\r\n             if (commentSection) commentSection.prepend(commentElement);\r\n-          });\r\n-        }\r\n+          });        }\r\n       }\r\n     }\r\n     showResult(resultMsg, true);\r\n+    \r\n+    // 検索ボックスを表示\r\n+    setTimeout(createUserSearchBox, 500);\r\n   }\r\n   // 動的ページ対応とMutationObserver\r\n   let lastUrl = location.href;\r\n   let checkInterval;\r\n@@ -465,14 +772,18 @@\n         lastUrl = location.href;\r\n         console.log('ytcmtck: ページ遷移を検出、ボタン再挿入を試行');\r\n         setTimeout(insertAnalyzeButton, 1000);\r\n         setTimeout(insertAnalyzeButton, 3000); // 遅延読み込み対応\r\n-      }\r\n-        // ボタンが消えた場合の復旧\r\n+      }      // ボタンが消えた場合の復旧\r\n       if (!document.getElementById('ytcmtck-analyze-btn') && findInsertTarget()) {\r\n         console.log('ytcmtck: ボタンが消失、再挿入');\r\n         insertAnalyzeButton();\r\n       }\r\n+      \r\n+      // 検索ボックスが消えた場合の復旧（解析実行後のみ）\r\n+      if (allComments.length > 0 && !document.getElementById('ytcmtck-user-search')) {\r\n+        setTimeout(createUserSearchBox, 500);\r\n+      }\r\n     }, 2000);\r\n   }\r\n \r\n   // 初期化\r\n"
                },
                {
                    "date": 1750436788634,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -235,13 +235,74 @@\n     if (existingSearch) {\r\n       existingSearch.remove();\r\n     }\r\n \r\n-    // #contentsを探す\r\n-    const contentsElement = document.querySelector('#contents.style-scope.ytd-item-section-renderer');\r\n-    if (!contentsElement) {\r\n-      console.log('ytcmtck: #contents が見つかりません');\r\n-      return;\r\n+    // 挿入先を探す（複数のセレクタを試行）\r\n+    let targetElement = null;\r\n+    const selectors = [\r\n+      '#contents.style-scope.ytd-item-section-renderer',\r\n+      '#contents',\r\n+      'ytd-item-section-renderer #contents',\r\n+      '[role=\"main\"] #contents',\r\n+      'ytd-comments #contents',\r\n+      'ytd-item-section-renderer[page-subtype=\"comments\"] #contents'\r\n+    ];\r\n+\r\n+    for (const selector of selectors) {\r\n+      targetElement = document.querySelector(selector);\r\n+      if (targetElement) {\r\n+        console.log(`ytcmtck: 挿入先が見つかりました: ${selector}`);\r\n+        break;\r\n+      }\r\n+    }    if (!targetElement) {\r\n+      console.log('ytcmtck: 適切な挿入先が見つかりません。利用可能な要素をデバッグ出力します...');\r\n+      // デバッグ用：コメント関連の要素を探す\r\n+      const commentsSection = document.querySelector('ytd-comments');\r\n+      const itemSectionRenderers = document.querySelectorAll('ytd-item-section-renderer');\r\n+      const contentsElements = document.querySelectorAll('#contents');\r\n+      const pageManager = document.querySelector('ytd-page-manager');\r\n+      const watchFlexy = document.querySelector('ytd-watch-flexy');\r\n+      \r\n+      console.log('ytcmtck: ytd-comments:', commentsSection);\r\n+      console.log('ytcmtck: ytd-item-section-renderer 要素数:', itemSectionRenderers.length);\r\n+      console.log('ytcmtck: #contents 要素数:', contentsElements.length);\r\n+      console.log('ytcmtck: ytd-page-manager:', pageManager);\r\n+      console.log('ytcmtck: ytd-watch-flexy:', watchFlexy);\r\n+      \r\n+      // 詳細デバッグ：各要素の属性を確認\r\n+      itemSectionRenderers.forEach((element, index) => {\r\n+        console.log(`ytcmtck: ytd-item-section-renderer[${index}]:`, {\r\n+          'page-subtype': element.getAttribute('page-subtype'),\r\n+          'section-identifier': element.getAttribute('section-identifier'),\r\n+          'class': element.className,\r\n+          'id': element.id,\r\n+          'hasContents': !!element.querySelector('#contents')\r\n+        });\r\n+      });\r\n+      \r\n+      // フォールバック戦略を拡張\r\n+      if (commentsSection) {\r\n+        targetElement = commentsSection;\r\n+        console.log('ytcmtck: フォールバック1: ytd-commentsを使用');\r\n+      } else if (itemSectionRenderers.length > 0) {\r\n+        // コメント関連のytd-item-section-rendererを優先\r\n+        const commentsRenderer = Array.from(itemSectionRenderers).find(el => \r\n+          el.getAttribute('page-subtype') === 'comments' || \r\n+          el.getAttribute('section-identifier') === 'comments' ||\r\n+          el.querySelector('#contents')\r\n+        );\r\n+        targetElement = commentsRenderer || itemSectionRenderers[0];\r\n+        console.log('ytcmtck: フォールバック2: ytd-item-section-rendererを使用');\r\n+      } else if (contentsElements.length > 0) {\r\n+        targetElement = contentsElements[0].parentElement;\r\n+        console.log('ytcmtck: フォールバック3: #contentsの親要素を使用');\r\n+      } else if (watchFlexy) {\r\n+        targetElement = watchFlexy;\r\n+        console.log('ytcmtck: フォールバック4: ytd-watch-flexyを使用');\r\n+      } else {\r\n+        console.log('ytcmtck: 全てのフォールバック戦略が失敗しました');\r\n+        return;\r\n+      }\r\n     }\r\n \r\n     // 検索ボックスコンテナを作成\r\n     const searchContainer = document.createElement('div');\r\n@@ -334,14 +395,54 @@\n     searchInput.addEventListener('input', () => {\r\n       if (searchInput.value.trim() === '') {\r\n         searchResultsContainer.style.display = 'none';\r\n       }\r\n-    });\r\n-\r\n-    // #contentsの直前に挿入\r\n-    contentsElement.parentNode.insertBefore(searchContainer, contentsElement);\r\n+    });    // #contentsの直前に挿入（または適切な位置に挿入）\r\n+    let insertionSuccess = false;\r\n     \r\n-    console.log('ytcmtck: ユーザー検索ボックスを追加しました');\r\n+    try {\r\n+      if (targetElement.id === 'contents' || targetElement.querySelector('#contents')) {\r\n+        // targetElementが#contentsまたは#contentsを含む場合\r\n+        const actualContents = targetElement.id === 'contents' ? targetElement : targetElement.querySelector('#contents');\r\n+        if (actualContents && actualContents.parentNode) {\r\n+          actualContents.parentNode.insertBefore(searchContainer, actualContents);\r\n+          console.log('ytcmtck: ユーザー検索ボックスを#contentsの直前に挿入しました');\r\n+          insertionSuccess = true;\r\n+        }\r\n+      }\r\n+      \r\n+      if (!insertionSuccess) {\r\n+        // フォールバック：targetElementの最初に挿入\r\n+        if (targetElement.querySelector('*')) {\r\n+          targetElement.insertBefore(searchContainer, targetElement.firstElementChild);\r\n+        } else {\r\n+          targetElement.appendChild(searchContainer);\r\n+        }\r\n+        console.log('ytcmtck: ユーザー検索ボックスを要素内に挿入しました（フォールバック）');\r\n+        insertionSuccess = true;\r\n+      }\r\n+    } catch (error) {\r\n+      console.error('ytcmtck: 検索ボックス挿入エラー:', error);\r\n+      // 最終フォールバック：bodyに追加\r\n+      try {\r\n+        document.body.appendChild(searchContainer);\r\n+        searchContainer.style.position = 'fixed';\r\n+        searchContainer.style.top = '100px';\r\n+        searchContainer.style.left = '20px';\r\n+        searchContainer.style.zIndex = '9999';\r\n+        searchContainer.style.width = '400px';\r\n+        console.log('ytcmtck: 最終フォールバック - bodyに固定位置で挿入');\r\n+        insertionSuccess = true;\r\n+      } catch (finalError) {\r\n+        console.error('ytcmtck: 最終フォールバックも失敗:', finalError);\r\n+      }\r\n+    }\r\n+    \r\n+    if (insertionSuccess) {\r\n+      console.log('ytcmtck: ユーザー検索ボックスの挿入が完了しました');\r\n+    } else {\r\n+      console.log('ytcmtck: ユーザー検索ボックスの挿入に失敗しました');\r\n+    }\r\n   }\r\n \r\n   // 検索結果を表示\r\n   function displaySearchResults(results, query) {\r\n@@ -750,13 +851,27 @@\n             const commentSection = document.querySelector('#comments #contents');\r\n             if (commentSection) commentSection.prepend(commentElement);\r\n           });        }\r\n       }\r\n-    }\r\n-    showResult(resultMsg, true);\r\n+    }    showResult(resultMsg, true);\r\n     \r\n-    // 検索ボックスを表示\r\n-    setTimeout(createUserSearchBox, 500);\r\n+    // 検索ボックスを表示（複数回試行で確実に表示）\r\n+    setTimeout(() => {\r\n+      console.log('ytcmtck: 検索ボックス挿入（1回目）');\r\n+      createUserSearchBox();\r\n+    }, 500);\r\n+    setTimeout(() => {\r\n+      if (!document.getElementById('ytcmtck-user-search')) {\r\n+        console.log('ytcmtck: 検索ボックス挿入（2回目、リトライ）');\r\n+        createUserSearchBox();\r\n+      }\r\n+    }, 1500);\r\n+    setTimeout(() => {\r\n+      if (!document.getElementById('ytcmtck-user-search')) {\r\n+        console.log('ytcmtck: 検索ボックス挿入（3回目、最終リトライ）');\r\n+        createUserSearchBox();\r\n+      }\r\n+    }, 3000);\r\n   }\r\n   // 動的ページ対応とMutationObserver\r\n   let lastUrl = location.href;\r\n   let checkInterval;\r\n@@ -764,27 +879,35 @@\n \r\n   function startMonitoring() {\r\n     // MutationObserverを開始\r\n     observer = startObserver();\r\n-    \r\n-    // URLチェック用インターバル\r\n+      // URLチェック用インターバル\r\n     checkInterval = setInterval(() => {\r\n       if (location.href !== lastUrl) {\r\n         lastUrl = location.href;\r\n         console.log('ytcmtck: ページ遷移を検出、ボタン再挿入を試行');\r\n         setTimeout(insertAnalyzeButton, 1000);\r\n         setTimeout(insertAnalyzeButton, 3000); // 遅延読み込み対応\r\n-      }      // ボタンが消えた場合の復旧\r\n+      }\r\n+\r\n+      // ボタンが消えた場合の復旧\r\n       if (!document.getElementById('ytcmtck-analyze-btn') && findInsertTarget()) {\r\n         console.log('ytcmtck: ボタンが消失、再挿入');\r\n         insertAnalyzeButton();\r\n       }\r\n       \r\n       // 検索ボックスが消えた場合の復旧（解析実行後のみ）\r\n       if (allComments.length > 0 && !document.getElementById('ytcmtck-user-search')) {\r\n-        setTimeout(createUserSearchBox, 500);\r\n+        console.log('ytcmtck: 検索ボックスが消失、再挿入を試行');\r\n+        setTimeout(() => {\r\n+          // 再度チェックしてから再挿入\r\n+          if (!document.getElementById('ytcmtck-user-search')) {\r\n+            console.log('ytcmtck: 検索ボックス再挿入実行');\r\n+            createUserSearchBox();\r\n+          }\r\n+        }, 500);\r\n       }\r\n-    }, 2000);\r\n+    }, 1500); // チェック間隔を短縮（2000ms → 1500ms）\r\n   }\r\n \r\n   // 初期化\r\n   function init() {\r\n"
                },
                {
                    "date": 1750437784941,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -62,13 +62,17 @@\n     });\r\n     settingsBtn.addEventListener('mouseleave', () => {\r\n       settingsBtn.style.backgroundColor = 'transparent';\r\n     });\r\n-    \r\n-    additional.appendChild(settingsBtn);\r\n+      additional.appendChild(settingsBtn);\r\n     settingsBtn.addEventListener('click', showSettingsModal);\r\n     \r\n     console.log('ytcmtck: 解析ボタンを挿入しました');\r\n+    \r\n+    // 検索ボックスを表示（設定に応じて）\r\n+    setTimeout(() => {\r\n+      updateSearchBoxVisibility();\r\n+    }, 100);\r\n   }\r\n \r\n   // MutationObserverでDOM変更を監視\r\n   function startObserver() {\r\n@@ -132,9 +136,10 @@\n   let settings = {\r\n     showUsernames: true,\r\n     showComments: true,\r\n     useCustomBackground: false,\r\n-    backgroundColor: '#f9f9f9'\r\n+    backgroundColor: '#f9f9f9',\r\n+    showSearchBox: true\r\n   };\r\n \r\n   // 検索結果を格納する変数\r\n   let allComments = [];\r\n@@ -228,11 +233,58 @@\n \r\n       container.appendChild(colorCircle);\r\n     });    return container;\r\n   }  // ユーザーID検索ボックスを作成\r\n+  // 検索ボックスの表示状態を更新する関数\r\n+  function updateSearchBoxVisibility() {\r\n+    const existingSearchBox = document.getElementById('userSearchBox');\r\n+    \r\n+    if (settings.showSearchBox) {\r\n+      // 表示設定がONで、まだ検索ボックスがない場合は作成\r\n+      if (!existingSearchBox) {\r\n+        createUserSearchBox();\r\n+      }\r\n+    } else {\r\n+      // 表示設定がOFFで、検索ボックスがある場合は削除\r\n+      if (existingSearchBox) {\r\n+        existingSearchBox.remove();\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  // 検索ボックスの状態を更新（解析前後で説明文を変える）\r\n+  function updateSearchBoxState() {\r\n+    const searchBox = document.getElementById('userSearchBox');\r\n+    if (!searchBox) return;\r\n+\r\n+    const descElement = searchBox.querySelector('.search-desc');\r\n+    const inputElement = searchBox.querySelector('#userSearchInput');\r\n+    \r\n+    if (!descElement || !inputElement) return;\r\n+\r\n+    if (allComments && allComments.length > 0) {\r\n+      // 解析済み\r\n+      descElement.textContent = `${allComments.length}件のコメントから検索できます`;\r\n+      inputElement.placeholder = '例: @username';\r\n+      inputElement.disabled = false;\r\n+      inputElement.style.opacity = '1';\r\n+    } else {\r\n+      // 解析前\r\n+      descElement.textContent = 'コメント解析後に利用可能になります';\r\n+      inputElement.placeholder = '解析後に利用可能';\r\n+      inputElement.disabled = true;\r\n+      inputElement.style.opacity = '0.5';\r\n+    }\r\n+  }\r\n+\r\n   function createUserSearchBox() {\r\n+    // 設定で検索ボックスが非表示の場合は何もしない\r\n+    if (!settings.showSearchBox) {\r\n+      return;\r\n+    }\r\n+\r\n     // 既存の検索ボックスがある場合は削除\r\n-    const existingSearch = document.getElementById('ytcmtck-user-search');\r\n+    const existingSearch = document.getElementById('userSearchBox');\r\n     if (existingSearch) {\r\n       existingSearch.remove();\r\n     }\r\n \r\n@@ -305,9 +357,9 @@\n     }\r\n \r\n     // 検索ボックスコンテナを作成\r\n     const searchContainer = document.createElement('div');\r\n-    searchContainer.id = 'ytcmtck-user-search';\r\n+    searchContainer.id = 'userSearchBox';\r\n     searchContainer.style.margin = '16px 0';\r\n     searchContainer.style.padding = '16px';\r\n     searchContainer.style.backgroundColor = '#f8f9fa';\r\n     searchContainer.style.borderRadius = '8px';\r\n@@ -318,28 +370,48 @@\n     const searchTitle = document.createElement('h4');\r\n     searchTitle.textContent = 'ユーザーID検索';\r\n     searchTitle.style.margin = '0 0 12px 0';\r\n     searchTitle.style.fontSize = '14px';\r\n-    searchTitle.style.fontWeight = '500';\r\n-    searchTitle.style.color = '#0f0f0f';\r\n+    searchTitle.style.fontWeight = '500';    searchTitle.style.color = '#0f0f0f';\r\n     searchContainer.appendChild(searchTitle);\r\n \r\n+    // 説明文を追加\r\n+    const searchDescription = document.createElement('div');\r\n+    searchDescription.className = 'search-desc';\r\n+    searchDescription.style.fontSize = '12px';\r\n+    searchDescription.style.color = '#666';\r\n+    searchDescription.style.marginBottom = '12px';\r\n+    searchDescription.style.lineHeight = '1.4';\r\n+    \r\n+    if (allComments && allComments.length > 0) {\r\n+      searchDescription.textContent = `${allComments.length}件のコメントから検索できます`;\r\n+    } else {\r\n+      searchDescription.textContent = '先に「🔍コメント解析」ボタンを押してからご利用ください';\r\n+    }\r\n+    searchContainer.appendChild(searchDescription);\r\n+\r\n     // 検索入力欄\r\n     const searchInputContainer = document.createElement('div');\r\n     searchInputContainer.style.display = 'flex';\r\n     searchInputContainer.style.gap = '8px';\r\n-    searchInputContainer.style.marginBottom = '12px';\r\n-\r\n-    const searchInput = document.createElement('input');\r\n+    searchInputContainer.style.marginBottom = '12px';    const searchInput = document.createElement('input');\r\n+    searchInput.id = 'userSearchInput';\r\n     searchInput.type = 'text';\r\n-    searchInput.placeholder = '@ユーザーID を入力';\r\n+    searchInput.placeholder = allComments && allComments.length > 0 ? '@ユーザーID を入力' : '解析後に利用可能になります';\r\n     searchInput.style.flex = '1';\r\n     searchInput.style.padding = '8px 12px';\r\n     searchInput.style.border = '1px solid #ccc';\r\n     searchInput.style.borderRadius = '20px';\r\n     searchInput.style.fontSize = '14px';\r\n     searchInput.style.outline = 'none';\r\n     searchInput.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n+    \r\n+    // 解析前は入力を制限\r\n+    if (!allComments || allComments.length === 0) {\r\n+      searchInput.disabled = true;\r\n+      searchInput.style.opacity = '0.5';\r\n+      searchInput.style.backgroundColor = '#f9f9f9';\r\n+    }\r\n \r\n     const searchButton = document.createElement('button');\r\n     searchButton.textContent = '🔍';\r\n     searchButton.style.padding = '8px 16px';\r\n@@ -665,12 +737,33 @@\n \r\n     const colorPicker = createColorPicker(settings.backgroundColor, (color) => {\r\n       settings.backgroundColor = color;\r\n       saveSettings();\r\n-    });\r\n-    colorPickerSection.appendChild(colorPicker);\r\n+    });    colorPickerSection.appendChild(colorPicker);\r\n     modalContent.appendChild(colorPickerSection);\r\n \r\n+    // 検索ボックス表示設定\r\n+    const searchBoxRow = document.createElement('div');\r\n+    searchBoxRow.style.display = 'flex';\r\n+    searchBoxRow.style.justifyContent = 'space-between';\r\n+    searchBoxRow.style.alignItems = 'center';\r\n+    searchBoxRow.style.marginBottom = '32px';\r\n+\r\n+    const searchBoxLabel = document.createElement('span');\r\n+    searchBoxLabel.textContent = '検索ボックスを表示';\r\n+    searchBoxLabel.style.fontSize = '16px';\r\n+    searchBoxLabel.style.color = '#0f0f0f';\r\n+    searchBoxRow.appendChild(searchBoxLabel);\r\n+\r\n+    const searchBoxSwitch = createToggleSwitch(settings.showSearchBox, (value) => {\r\n+      settings.showSearchBox = value;\r\n+      saveSettings();\r\n+      // 検索ボックスの表示/非表示を即座に反映\r\n+      updateSearchBoxVisibility();\r\n+    });\r\n+    searchBoxRow.appendChild(searchBoxSwitch);\r\n+    modalContent.appendChild(searchBoxRow);\r\n+\r\n     // 閉じるボタン\r\n     const closeButton = document.createElement('button');\r\n     closeButton.textContent = '閉じる';\r\n     closeButton.style.width = '100%';\r\n@@ -785,8 +878,11 @@\n     // 全コメントを保存（検索用）\r\n     allComments = apiData.comments;\r\n     \r\n     showResult('解析が完了しました。\\nまもなく解析結果が表示されます。', false);\r\n+    \r\n+    // 検索ボックスの状態を更新\r\n+    updateSearchBoxState();\r\n     await new Promise(r => setTimeout(r, 1000));\r\n     \r\n     let resultMsg = '解析結果：\\n';\r\n     \r\n@@ -857,17 +953,15 @@\n     // 検索ボックスを表示（複数回試行で確実に表示）\r\n     setTimeout(() => {\r\n       console.log('ytcmtck: 検索ボックス挿入（1回目）');\r\n       createUserSearchBox();\r\n-    }, 500);\r\n-    setTimeout(() => {\r\n-      if (!document.getElementById('ytcmtck-user-search')) {\r\n+    }, 500);    setTimeout(() => {\r\n+      if (!document.getElementById('userSearchBox')) {\r\n         console.log('ytcmtck: 検索ボックス挿入（2回目、リトライ）');\r\n         createUserSearchBox();\r\n       }\r\n-    }, 1500);\r\n-    setTimeout(() => {\r\n-      if (!document.getElementById('ytcmtck-user-search')) {\r\n+    }, 1500);    setTimeout(() => {\r\n+      if (!document.getElementById('userSearchBox')) {\r\n         console.log('ytcmtck: 検索ボックス挿入（3回目、最終リトライ）');\r\n         createUserSearchBox();\r\n       }\r\n     }, 3000);\r\n@@ -893,15 +987,14 @@\n       if (!document.getElementById('ytcmtck-analyze-btn') && findInsertTarget()) {\r\n         console.log('ytcmtck: ボタンが消失、再挿入');\r\n         insertAnalyzeButton();\r\n       }\r\n-      \r\n-      // 検索ボックスが消えた場合の復旧（解析実行後のみ）\r\n-      if (allComments.length > 0 && !document.getElementById('ytcmtck-user-search')) {\r\n+        // 検索ボックスが消えた場合の復旧（解析実行後のみ）\r\n+      if (allComments.length > 0 && !document.getElementById('userSearchBox')) {\r\n         console.log('ytcmtck: 検索ボックスが消失、再挿入を試行');\r\n         setTimeout(() => {\r\n           // 再度チェックしてから再挿入\r\n-          if (!document.getElementById('ytcmtck-user-search')) {\r\n+          if (!document.getElementById('userSearchBox')) {\r\n             console.log('ytcmtck: 検索ボックス再挿入実行');\r\n             createUserSearchBox();\r\n           }\r\n         }, 500);\r\n"
                },
                {
                    "date": 1750437828433,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -67,11 +67,11 @@\n     settingsBtn.addEventListener('click', showSettingsModal);\r\n     \r\n     console.log('ytcmtck: 解析ボタンを挿入しました');\r\n     \r\n-    // 検索ボックスを表示（設定に応じて）\r\n+    // 解析ボタンが挿入されたら、検索ボックスも表示する\r\n     setTimeout(() => {\r\n-      updateSearchBoxVisibility();\r\n+      createUserSearchBox();\r\n     }, 100);\r\n   }\r\n \r\n   // MutationObserverでDOM変更を監視\r\n@@ -233,80 +233,55 @@\n \r\n       container.appendChild(colorCircle);\r\n     });    return container;\r\n   }  // ユーザーID検索ボックスを作成\r\n-  // 検索ボックスの表示状態を更新する関数\r\n-  function updateSearchBoxVisibility() {\r\n-    const existingSearchBox = document.getElementById('userSearchBox');\r\n-    \r\n-    if (settings.showSearchBox) {\r\n-      // 表示設定がONで、まだ検索ボックスがない場合は作成\r\n-      if (!existingSearchBox) {\r\n-        createUserSearchBox();\r\n-      }\r\n-    } else {\r\n-      // 表示設定がOFFで、検索ボックスがある場合は削除\r\n-      if (existingSearchBox) {\r\n-        existingSearchBox.remove();\r\n-      }\r\n-    }\r\n-  }\r\n-\r\n-  // 検索ボックスの状態を更新（解析前後で説明文を変える）\r\n-  function updateSearchBoxState() {\r\n-    const searchBox = document.getElementById('userSearchBox');\r\n-    if (!searchBox) return;\r\n-\r\n-    const descElement = searchBox.querySelector('.search-desc');\r\n-    const inputElement = searchBox.querySelector('#userSearchInput');\r\n-    \r\n-    if (!descElement || !inputElement) return;\r\n-\r\n-    if (allComments && allComments.length > 0) {\r\n-      // 解析済み\r\n-      descElement.textContent = `${allComments.length}件のコメントから検索できます`;\r\n-      inputElement.placeholder = '例: @username';\r\n-      inputElement.disabled = false;\r\n-      inputElement.style.opacity = '1';\r\n-    } else {\r\n-      // 解析前\r\n-      descElement.textContent = 'コメント解析後に利用可能になります';\r\n-      inputElement.placeholder = '解析後に利用可能';\r\n-      inputElement.disabled = true;\r\n-      inputElement.style.opacity = '0.5';\r\n-    }\r\n-  }\r\n-\r\n   function createUserSearchBox() {\r\n     // 設定で検索ボックスが非表示の場合は何もしない\r\n     if (!settings.showSearchBox) {\r\n+      console.log('ytcmtck: 検索ボックスが設定で無効化されています');\r\n       return;\r\n     }\r\n-\r\n+    \r\n     // 既存の検索ボックスがある場合は削除\r\n-    const existingSearch = document.getElementById('userSearchBox');\r\n+    const existingSearch = document.getElementById('ytcmtck-user-search');\r\n     if (existingSearch) {\r\n       existingSearch.remove();\r\n     }\r\n \r\n-    // 挿入先を探す（複数のセレクタを試行）\r\n+    // コメント解析ボタンの下に表示するため、まず解析ボタンの親要素を探す\r\n     let targetElement = null;\r\n-    const selectors = [\r\n-      '#contents.style-scope.ytd-item-section-renderer',\r\n-      '#contents',\r\n-      'ytd-item-section-renderer #contents',\r\n-      '[role=\"main\"] #contents',\r\n-      'ytd-comments #contents',\r\n-      'ytd-item-section-renderer[page-subtype=\"comments\"] #contents'\r\n-    ];\r\n+    \r\n+    // 1. 解析ボタンが存在する場合、その親要素（#additional-section）の後に挿入\r\n+    const analyzeButton = document.getElementById('ytcmtck-analyze-btn');\r\n+    if (analyzeButton && analyzeButton.parentElement) {\r\n+      const additionalSection = analyzeButton.parentElement; // #additional-section\r\n+      const commentsHeader = additionalSection.parentElement; // ytd-comments-header-renderer\r\n+      if (commentsHeader) {\r\n+        targetElement = commentsHeader;\r\n+        console.log('ytcmtck: 解析ボタンの下（ytd-comments-header-renderer内）に挿入');\r\n+      }\r\n+    }\r\n+    \r\n+    // 2. フォールバック：従来の方法で挿入先を探す\r\n+    if (!targetElement) {\r\n+      const selectors = [\r\n+        'ytd-comments-header-renderer',\r\n+        '#contents.style-scope.ytd-item-section-renderer',\r\n+        '#contents',\r\n+        'ytd-item-section-renderer #contents',\r\n+        '[role=\"main\"] #contents',\r\n+        'ytd-comments #contents',\r\n+        'ytd-item-section-renderer[page-subtype=\"comments\"] #contents'\r\n+      ];\r\n \r\n-    for (const selector of selectors) {\r\n-      targetElement = document.querySelector(selector);\r\n-      if (targetElement) {\r\n-        console.log(`ytcmtck: 挿入先が見つかりました: ${selector}`);\r\n-        break;\r\n+      for (const selector of selectors) {\r\n+        targetElement = document.querySelector(selector);\r\n+        if (targetElement) {\r\n+          console.log(`ytcmtck: フォールバック挿入先が見つかりました: ${selector}`);\r\n+          break;\r\n+        }\r\n       }\r\n-    }    if (!targetElement) {\r\n+    }if (!targetElement) {\r\n       console.log('ytcmtck: 適切な挿入先が見つかりません。利用可能な要素をデバッグ出力します...');\r\n       // デバッグ用：コメント関連の要素を探す\r\n       const commentsSection = document.querySelector('ytd-comments');\r\n       const itemSectionRenderers = document.querySelectorAll('ytd-item-section-renderer');\r\n@@ -353,68 +328,63 @@\n       } else {\r\n         console.log('ytcmtck: 全てのフォールバック戦略が失敗しました');\r\n         return;\r\n       }\r\n-    }\r\n-\r\n-    // 検索ボックスコンテナを作成\r\n+    }    // 検索ボックスコンテナを作成\r\n     const searchContainer = document.createElement('div');\r\n-    searchContainer.id = 'userSearchBox';\r\n-    searchContainer.style.margin = '16px 0';\r\n+    searchContainer.id = 'ytcmtck-user-search';\r\n+    searchContainer.style.margin = '8px 0 16px 0'; // 上マージンを少し狭く\r\n     searchContainer.style.padding = '16px';\r\n     searchContainer.style.backgroundColor = '#f8f9fa';\r\n     searchContainer.style.borderRadius = '8px';\r\n     searchContainer.style.border = '1px solid #e1e5e9';\r\n     searchContainer.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n-\r\n-    // タイトル\r\n+    searchContainer.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)'; // 軽い影を追加    // タイトル\r\n     const searchTitle = document.createElement('h4');\r\n-    searchTitle.textContent = 'ユーザーID検索';\r\n-    searchTitle.style.margin = '0 0 12px 0';\r\n+    searchTitle.textContent = '🔍 ユーザーID検索';\r\n+    searchTitle.style.margin = '0 0 8px 0';\r\n     searchTitle.style.fontSize = '14px';\r\n-    searchTitle.style.fontWeight = '500';    searchTitle.style.color = '#0f0f0f';\r\n+    searchTitle.style.fontWeight = '500';\r\n+    searchTitle.style.color = '#0f0f0f';\r\n     searchContainer.appendChild(searchTitle);\r\n-\r\n+    \r\n     // 説明文を追加\r\n     const searchDescription = document.createElement('div');\r\n-    searchDescription.className = 'search-desc';\r\n     searchDescription.style.fontSize = '12px';\r\n     searchDescription.style.color = '#666';\r\n     searchDescription.style.marginBottom = '12px';\r\n     searchDescription.style.lineHeight = '1.4';\r\n     \r\n-    if (allComments && allComments.length > 0) {\r\n+    if (allComments.length === 0) {\r\n+      searchDescription.textContent = '先に「🔍コメント解析」ボタンを押してからご利用ください';\r\n+    } else {\r\n       searchDescription.textContent = `${allComments.length}件のコメントから検索できます`;\r\n-    } else {\r\n-      searchDescription.textContent = '先に「🔍コメント解析」ボタンを押してからご利用ください';\r\n     }\r\n     searchContainer.appendChild(searchDescription);\r\n \r\n     // 検索入力欄\r\n     const searchInputContainer = document.createElement('div');\r\n     searchInputContainer.style.display = 'flex';\r\n     searchInputContainer.style.gap = '8px';\r\n     searchInputContainer.style.marginBottom = '12px';    const searchInput = document.createElement('input');\r\n-    searchInput.id = 'userSearchInput';\r\n     searchInput.type = 'text';\r\n-    searchInput.placeholder = allComments && allComments.length > 0 ? '@ユーザーID を入力' : '解析後に利用可能になります';\r\n+    searchInput.placeholder = allComments.length === 0 ? '解析後に利用可能になります' : '@ユーザーID を入力';\r\n     searchInput.style.flex = '1';\r\n     searchInput.style.padding = '8px 12px';\r\n     searchInput.style.border = '1px solid #ccc';\r\n     searchInput.style.borderRadius = '20px';\r\n     searchInput.style.fontSize = '14px';\r\n     searchInput.style.outline = 'none';\r\n     searchInput.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n     \r\n-    // 解析前は入力を制限\r\n-    if (!allComments || allComments.length === 0) {\r\n-      searchInput.disabled = true;\r\n-      searchInput.style.opacity = '0.5';\r\n+    // 解析前は入力を無効化\r\n+    if (allComments.length === 0) {\r\n+      searchInput.disabled = false; // 無効化はしないが、検索時にメッセージを表示\r\n       searchInput.style.backgroundColor = '#f9f9f9';\r\n     }\r\n \r\n     const searchButton = document.createElement('button');\r\n-    searchButton.textContent = '🔍';\r\n+    searchButton.textContent = '検索';\r\n     searchButton.style.padding = '8px 16px';\r\n     searchButton.style.border = 'none';\r\n     searchButton.style.borderRadius = '20px';\r\n     searchButton.style.backgroundColor = '#007AFF';\r\n@@ -437,18 +407,33 @@\n     // 検索結果表示エリア\r\n     searchResultsContainer = document.createElement('div');\r\n     searchResultsContainer.id = 'ytcmtck-search-results';\r\n     searchResultsContainer.style.display = 'none';\r\n-    searchContainer.appendChild(searchResultsContainer);\r\n-\r\n-    // 検索機能\r\n+    searchContainer.appendChild(searchResultsContainer);    // 検索機能\r\n     const performSearch = () => {\r\n       const query = searchInput.value.trim();\r\n       if (!query) {\r\n         searchResultsContainer.style.display = 'none';\r\n         return;\r\n       }\r\n \r\n+      // 解析前の場合の処理\r\n+      if (allComments.length === 0) {\r\n+        searchResultsContainer.innerHTML = '';\r\n+        searchResultsContainer.style.display = 'block';\r\n+        \r\n+        const noAnalysisMessage = document.createElement('div');\r\n+        noAnalysisMessage.innerHTML = `\r\n+          <div style=\"text-align: center; padding: 20px; color: #666;\">\r\n+            <div style=\"font-size: 18px; margin-bottom: 8px;\">🔍</div>\r\n+            <div style=\"font-weight: 500; margin-bottom: 8px;\">まず「🔍コメント解析」ボタンを押してください</div>\r\n+            <div style=\"font-size: 14px;\">解析後にユーザーIDで検索できるようになります</div>\r\n+          </div>\r\n+        `;\r\n+        searchResultsContainer.appendChild(noAnalysisMessage);\r\n+        return;\r\n+      }\r\n+\r\n       // @を自動追加\r\n       const searchQuery = query.startsWith('@') ? query : '@' + query;\r\n       const results = allComments.filter(comment => \r\n         comment.author.toLowerCase().includes(searchQuery.toLowerCase().substring(1))\r\n@@ -467,31 +452,54 @@\n     searchInput.addEventListener('input', () => {\r\n       if (searchInput.value.trim() === '') {\r\n         searchResultsContainer.style.display = 'none';\r\n       }\r\n-    });    // #contentsの直前に挿入（または適切な位置に挿入）\r\n+    });    // コメント解析ボタンの下に挿入\r\n     let insertionSuccess = false;\r\n     \r\n     try {\r\n-      if (targetElement.id === 'contents' || targetElement.querySelector('#contents')) {\r\n-        // targetElementが#contentsまたは#contentsを含む場合\r\n-        const actualContents = targetElement.id === 'contents' ? targetElement : targetElement.querySelector('#contents');\r\n-        if (actualContents && actualContents.parentNode) {\r\n-          actualContents.parentNode.insertBefore(searchContainer, actualContents);\r\n-          console.log('ytcmtck: ユーザー検索ボックスを#contentsの直前に挿入しました');\r\n+      const analyzeButton = document.getElementById('ytcmtck-analyze-btn');\r\n+      \r\n+      if (analyzeButton && analyzeButton.parentElement) {\r\n+        // 解析ボタンの親要素（#additional-section）の後に挿入\r\n+        const additionalSection = analyzeButton.parentElement;\r\n+        const commentsHeader = additionalSection.parentElement;\r\n+        \r\n+        if (commentsHeader) {\r\n+          // ytd-comments-header-rendererの後に挿入\r\n+          commentsHeader.parentNode.insertBefore(searchContainer, commentsHeader.nextSibling);\r\n+          console.log('ytcmtck: ユーザー検索ボックスをコメント解析ボタンの下に挿入しました');\r\n           insertionSuccess = true;\r\n         }\r\n       }\r\n       \r\n-      if (!insertionSuccess) {\r\n-        // フォールバック：targetElementの最初に挿入\r\n-        if (targetElement.querySelector('*')) {\r\n-          targetElement.insertBefore(searchContainer, targetElement.firstElementChild);\r\n+      // フォールバック1：ytd-comments-header-rendererがtargetElementの場合\r\n+      if (!insertionSuccess && targetElement && targetElement.tagName === 'YTD-COMMENTS-HEADER-RENDERER') {\r\n+        targetElement.parentNode.insertBefore(searchContainer, targetElement.nextSibling);\r\n+        console.log('ytcmtck: ユーザー検索ボックスをytd-comments-header-rendererの後に挿入しました');\r\n+        insertionSuccess = true;\r\n+      }\r\n+      \r\n+      // フォールバック2：従来の挿入方法\r\n+      if (!insertionSuccess && targetElement) {\r\n+        if (targetElement.id === 'contents' || targetElement.querySelector('#contents')) {\r\n+          // targetElementが#contentsまたは#contentsを含む場合\r\n+          const actualContents = targetElement.id === 'contents' ? targetElement : targetElement.querySelector('#contents');\r\n+          if (actualContents && actualContents.parentNode) {\r\n+            actualContents.parentNode.insertBefore(searchContainer, actualContents);\r\n+            console.log('ytcmtck: ユーザー検索ボックスを#contentsの直前に挿入しました');\r\n+            insertionSuccess = true;\r\n+          }\r\n         } else {\r\n-          targetElement.appendChild(searchContainer);\r\n+          // targetElementの最初に挿入\r\n+          if (targetElement.querySelector('*')) {\r\n+            targetElement.insertBefore(searchContainer, targetElement.firstElementChild);\r\n+          } else {\r\n+            targetElement.appendChild(searchContainer);\r\n+          }\r\n+          console.log('ytcmtck: ユーザー検索ボックスを要素内に挿入しました（フォールバック）');\r\n+          insertionSuccess = true;\r\n         }\r\n-        console.log('ytcmtck: ユーザー検索ボックスを要素内に挿入しました（フォールバック）');\r\n-        insertionSuccess = true;\r\n       }\r\n     } catch (error) {\r\n       console.error('ytcmtck: 検索ボックス挿入エラー:', error);\r\n       // 最終フォールバック：bodyに追加\r\n@@ -737,33 +745,12 @@\n \r\n     const colorPicker = createColorPicker(settings.backgroundColor, (color) => {\r\n       settings.backgroundColor = color;\r\n       saveSettings();\r\n-    });    colorPickerSection.appendChild(colorPicker);\r\n+    });\r\n+    colorPickerSection.appendChild(colorPicker);\r\n     modalContent.appendChild(colorPickerSection);\r\n \r\n-    // 検索ボックス表示設定\r\n-    const searchBoxRow = document.createElement('div');\r\n-    searchBoxRow.style.display = 'flex';\r\n-    searchBoxRow.style.justifyContent = 'space-between';\r\n-    searchBoxRow.style.alignItems = 'center';\r\n-    searchBoxRow.style.marginBottom = '32px';\r\n-\r\n-    const searchBoxLabel = document.createElement('span');\r\n-    searchBoxLabel.textContent = '検索ボックスを表示';\r\n-    searchBoxLabel.style.fontSize = '16px';\r\n-    searchBoxLabel.style.color = '#0f0f0f';\r\n-    searchBoxRow.appendChild(searchBoxLabel);\r\n-\r\n-    const searchBoxSwitch = createToggleSwitch(settings.showSearchBox, (value) => {\r\n-      settings.showSearchBox = value;\r\n-      saveSettings();\r\n-      // 検索ボックスの表示/非表示を即座に反映\r\n-      updateSearchBoxVisibility();\r\n-    });\r\n-    searchBoxRow.appendChild(searchBoxSwitch);\r\n-    modalContent.appendChild(searchBoxRow);\r\n-\r\n     // 閉じるボタン\r\n     const closeButton = document.createElement('button');\r\n     closeButton.textContent = '閉じる';\r\n     closeButton.style.width = '100%';\r\n@@ -859,9 +846,38 @@\n       return `${minutes} 分前`;\r\n     } else {\r\n       return '今';\r\n     }\r\n-  }  async function onAnalyzeClick() {\r\n+  }\r\n+\r\n+  // 検索ボックスの状態を更新\r\n+  function updateSearchBoxState() {\r\n+    const searchBox = document.getElementById('ytcmtck-user-search');\r\n+    if (!searchBox) return;\r\n+    \r\n+    const searchDescription = searchBox.querySelector('div:nth-child(2)'); // 説明文\r\n+    const searchInput = searchBox.querySelector('input');\r\n+    \r\n+    if (searchDescription) {\r\n+      if (allComments.length === 0) {\r\n+        searchDescription.textContent = '先に「🔍コメント解析」ボタンを押してからご利用ください';\r\n+      } else {\r\n+        searchDescription.textContent = `${allComments.length}件のコメントから検索できます`;\r\n+      }\r\n+    }\r\n+    \r\n+    if (searchInput) {\r\n+      if (allComments.length === 0) {\r\n+        searchInput.placeholder = '解析後に利用可能になります';\r\n+        searchInput.style.backgroundColor = '#f9f9f9';\r\n+      } else {\r\n+        searchInput.placeholder = '@ユーザーID を入力';\r\n+        searchInput.style.backgroundColor = '#ffffff';\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  async function onAnalyzeClick() {\r\n     showResult('解析中です', false);\r\n     \r\n     const videoId = getVideoId();\r\n     if (!videoId) {\r\n@@ -878,11 +894,8 @@\n     // 全コメントを保存（検索用）\r\n     allComments = apiData.comments;\r\n     \r\n     showResult('解析が完了しました。\\nまもなく解析結果が表示されます。', false);\r\n-    \r\n-    // 検索ボックスの状態を更新\r\n-    updateSearchBoxState();\r\n     await new Promise(r => setTimeout(r, 1000));\r\n     \r\n     let resultMsg = '解析結果：\\n';\r\n     \r\n@@ -949,21 +962,30 @@\n           });        }\r\n       }\r\n     }    showResult(resultMsg, true);\r\n     \r\n+    // 検索ボックスの状態を更新\r\n+    updateSearchBoxState();\r\n+    \r\n     // 検索ボックスを表示（複数回試行で確実に表示）\r\n     setTimeout(() => {\r\n       console.log('ytcmtck: 検索ボックス挿入（1回目）');\r\n       createUserSearchBox();\r\n-    }, 500);    setTimeout(() => {\r\n-      if (!document.getElementById('userSearchBox')) {\r\n+    }, 500);\r\n+    setTimeout(() => {\r\n+      if (!document.getElementById('ytcmtck-user-search')) {\r\n         console.log('ytcmtck: 検索ボックス挿入（2回目、リトライ）');\r\n         createUserSearchBox();\r\n+      } else {\r\n+        updateSearchBoxState();\r\n       }\r\n-    }, 1500);    setTimeout(() => {\r\n-      if (!document.getElementById('userSearchBox')) {\r\n+    }, 1500);\r\n+    setTimeout(() => {\r\n+      if (!document.getElementById('ytcmtck-user-search')) {\r\n         console.log('ytcmtck: 検索ボックス挿入（3回目、最終リトライ）');\r\n         createUserSearchBox();\r\n+      } else {\r\n+        updateSearchBoxState();\r\n       }\r\n     }, 3000);\r\n   }\r\n   // 動的ページ対応とMutationObserver\r\n@@ -987,14 +1009,15 @@\n       if (!document.getElementById('ytcmtck-analyze-btn') && findInsertTarget()) {\r\n         console.log('ytcmtck: ボタンが消失、再挿入');\r\n         insertAnalyzeButton();\r\n       }\r\n-        // 検索ボックスが消えた場合の復旧（解析実行後のみ）\r\n-      if (allComments.length > 0 && !document.getElementById('userSearchBox')) {\r\n+      \r\n+      // 検索ボックスが消えた場合の復旧（解析実行後のみ）\r\n+      if (allComments.length > 0 && !document.getElementById('ytcmtck-user-search')) {\r\n         console.log('ytcmtck: 検索ボックスが消失、再挿入を試行');\r\n         setTimeout(() => {\r\n           // 再度チェックしてから再挿入\r\n-          if (!document.getElementById('userSearchBox')) {\r\n+          if (!document.getElementById('ytcmtck-user-search')) {\r\n             console.log('ytcmtck: 検索ボックス再挿入実行');\r\n             createUserSearchBox();\r\n           }\r\n         }, 500);\r\n"
                },
                {
                    "date": 1750437950759,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -745,12 +745,33 @@\n \r\n     const colorPicker = createColorPicker(settings.backgroundColor, (color) => {\r\n       settings.backgroundColor = color;\r\n       saveSettings();\r\n-    });\r\n-    colorPickerSection.appendChild(colorPicker);\r\n+    });    colorPickerSection.appendChild(colorPicker);\r\n     modalContent.appendChild(colorPickerSection);\r\n \r\n+    // 検索ボックス表示設定\r\n+    const searchBoxRow = document.createElement('div');\r\n+    searchBoxRow.style.display = 'flex';\r\n+    searchBoxRow.style.justifyContent = 'space-between';\r\n+    searchBoxRow.style.alignItems = 'center';\r\n+    searchBoxRow.style.marginBottom = '32px';\r\n+\r\n+    const searchBoxLabel = document.createElement('span');\r\n+    searchBoxLabel.textContent = '検索ボックスを表示';\r\n+    searchBoxLabel.style.fontSize = '16px';\r\n+    searchBoxLabel.style.color = '#0f0f0f';\r\n+    searchBoxRow.appendChild(searchBoxLabel);\r\n+\r\n+    const searchBoxSwitch = createToggleSwitch(settings.showSearchBox, (value) => {\r\n+      settings.showSearchBox = value;\r\n+      saveSettings();\r\n+      // 検索ボックスの表示/非表示を即座に反映\r\n+      updateSearchBoxVisibility();\r\n+    });\r\n+    searchBoxRow.appendChild(searchBoxSwitch);\r\n+    modalContent.appendChild(searchBoxRow);\r\n+\r\n     // 閉じるボタン\r\n     const closeButton = document.createElement('button');\r\n     closeButton.textContent = '閉じる';\r\n     closeButton.style.width = '100%';\r\n"
                },
                {
                    "date": 1750438055420,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -887,9 +887,9 @@\n     }\r\n     \r\n     if (searchInput) {\r\n       if (allComments.length === 0) {\r\n-        searchInput.placeholder = '解析後に利用可能になります';\r\n+        searchInput.placeholder = '解析後に利用可能に';\r\n         searchInput.style.backgroundColor = '#f9f9f9';\r\n       } else {\r\n         searchInput.placeholder = '@ユーザーID を入力';\r\n         searchInput.style.backgroundColor = '#ffffff';\r\n"
                },
                {
                    "date": 1750438078877,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -879,17 +879,17 @@\n     const searchInput = searchBox.querySelector('input');\r\n     \r\n     if (searchDescription) {\r\n       if (allComments.length === 0) {\r\n-        searchDescription.textContent = '先に「🔍コメント解析」ボタンを押してからご利用ください';\r\n+        searchDescription.textContent = '先に「🔍コメント解析」ボタンを押してから使用してください。';\r\n       } else {\r\n         searchDescription.textContent = `${allComments.length}件のコメントから検索できます`;\r\n       }\r\n     }\r\n     \r\n     if (searchInput) {\r\n       if (allComments.length === 0) {\r\n-        searchInput.placeholder = '解析後に利用可能に';\r\n+        searchInput.placeholder = '解析後に利用可能です';\r\n         searchInput.style.backgroundColor = '#f9f9f9';\r\n       } else {\r\n         searchInput.placeholder = '@ユーザーID を入力';\r\n         searchInput.style.backgroundColor = '#ffffff';\r\n"
                },
                {
                    "date": 1750438195860,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -64,14 +64,13 @@\n       settingsBtn.style.backgroundColor = 'transparent';\r\n     });\r\n       additional.appendChild(settingsBtn);\r\n     settingsBtn.addEventListener('click', showSettingsModal);\r\n+      console.log('ytcmtck: 解析ボタンを挿入しました');\r\n     \r\n-    console.log('ytcmtck: 解析ボタンを挿入しました');\r\n-    \r\n-    // 解析ボタンが挿入されたら、検索ボックスも表示する\r\n+    // 検索ボックスを表示（設定に応じて）\r\n     setTimeout(() => {\r\n-      createUserSearchBox();\r\n+      updateSearchBoxVisibility();\r\n     }, 100);\r\n   }\r\n \r\n   // MutationObserverでDOM変更を監視\r\n@@ -194,9 +193,8 @@\n     });\r\n     \r\n     return switchContainer;\r\n   }\r\n-\r\n   // カラーサークルピッカーを作成\r\n   function createColorPicker(selectedColor, onChange) {\r\n     const colors = [\r\n       '#f9f9f9', '#e6ffe6', '#ffe6e6', '#e6f3ff', '#fff2e6',\r\n@@ -232,9 +230,28 @@\n       });\r\n \r\n       container.appendChild(colorCircle);\r\n     });    return container;\r\n-  }  // ユーザーID検索ボックスを作成\r\n+  }\r\n+\r\n+  // 検索ボックスの表示状態を更新する関数\r\n+  function updateSearchBoxVisibility() {\r\n+    const existingSearchBox = document.getElementById('ytcmtck-user-search');\r\n+    \r\n+    if (settings.showSearchBox) {\r\n+      // 表示設定がONで、まだ検索ボックスがない場合は作成\r\n+      if (!existingSearchBox) {\r\n+        console.log('ytcmtck: 検索ボックス表示設定がON - 作成します');\r\n+        createUserSearchBox();\r\n+      }\r\n+    } else {\r\n+      // 表示設定がOFFで、検索ボックスがある場合は削除\r\n+      if (existingSearchBox) {\r\n+        console.log('ytcmtck: 検索ボックス表示設定がOFF - 削除します');\r\n+        existingSearchBox.remove();\r\n+      }\r\n+    }\r\n+  }// ユーザーID検索ボックスを作成\r\n   function createUserSearchBox() {\r\n     // 設定で検索ボックスが非表示の場合は何もしない\r\n     if (!settings.showSearchBox) {\r\n       console.log('ytcmtck: 検索ボックスが設定で無効化されています');\r\n@@ -354,9 +371,9 @@\n     searchDescription.style.marginBottom = '12px';\r\n     searchDescription.style.lineHeight = '1.4';\r\n     \r\n     if (allComments.length === 0) {\r\n-      searchDescription.textContent = '先に「🔍コメント解析」ボタンを押してからご利用ください';\r\n+      searchDescription.textContent = '先に「🔍コメント解析」ボタンを押してから使用してください';\r\n     } else {\r\n       searchDescription.textContent = `${allComments.length}件のコメントから検索できます`;\r\n     }\r\n     searchContainer.appendChild(searchDescription);\r\n@@ -366,9 +383,9 @@\n     searchInputContainer.style.display = 'flex';\r\n     searchInputContainer.style.gap = '8px';\r\n     searchInputContainer.style.marginBottom = '12px';    const searchInput = document.createElement('input');\r\n     searchInput.type = 'text';\r\n-    searchInput.placeholder = allComments.length === 0 ? '解析後に利用可能になります' : '@ユーザーID を入力';\r\n+    searchInput.placeholder = allComments.length === 0 ? '解析後に使用可能です' : '@ユーザーID を入力';\r\n     searchInput.style.flex = '1';\r\n     searchInput.style.padding = '8px 12px';\r\n     searchInput.style.border = '1px solid #ccc';\r\n     searchInput.style.borderRadius = '20px';\r\n@@ -879,17 +896,17 @@\n     const searchInput = searchBox.querySelector('input');\r\n     \r\n     if (searchDescription) {\r\n       if (allComments.length === 0) {\r\n-        searchDescription.textContent = '先に「🔍コメント解析」ボタンを押してから使用してください。';\r\n+        searchDescription.textContent = '先に「🔍コメント解析」ボタンを押してからご利用ください';\r\n       } else {\r\n         searchDescription.textContent = `${allComments.length}件のコメントから検索できます`;\r\n       }\r\n     }\r\n     \r\n     if (searchInput) {\r\n       if (allComments.length === 0) {\r\n-        searchInput.placeholder = '解析後に利用可能です';\r\n+        searchInput.placeholder = '解析後に利用可能になります';\r\n         searchInput.style.backgroundColor = '#f9f9f9';\r\n       } else {\r\n         searchInput.placeholder = '@ユーザーID を入力';\r\n         searchInput.style.backgroundColor = '#ffffff';\r\n@@ -985,26 +1002,25 @@\n     }    showResult(resultMsg, true);\r\n     \r\n     // 検索ボックスの状態を更新\r\n     updateSearchBoxState();\r\n-    \r\n-    // 検索ボックスを表示（複数回試行で確実に表示）\r\n+      // 検索ボックスを表示（複数回試行で確実に表示）\r\n     setTimeout(() => {\r\n       console.log('ytcmtck: 検索ボックス挿入（1回目）');\r\n-      createUserSearchBox();\r\n+      updateSearchBoxVisibility();\r\n     }, 500);\r\n     setTimeout(() => {\r\n       if (!document.getElementById('ytcmtck-user-search')) {\r\n         console.log('ytcmtck: 検索ボックス挿入（2回目、リトライ）');\r\n-        createUserSearchBox();\r\n+        updateSearchBoxVisibility();\r\n       } else {\r\n         updateSearchBoxState();\r\n       }\r\n     }, 1500);\r\n     setTimeout(() => {\r\n       if (!document.getElementById('ytcmtck-user-search')) {\r\n         console.log('ytcmtck: 検索ボックス挿入（3回目、最終リトライ）');\r\n-        createUserSearchBox();\r\n+        updateSearchBoxVisibility();\r\n       } else {\r\n         updateSearchBoxState();\r\n       }\r\n     }, 3000);\r\n@@ -1030,11 +1046,10 @@\n       if (!document.getElementById('ytcmtck-analyze-btn') && findInsertTarget()) {\r\n         console.log('ytcmtck: ボタンが消失、再挿入');\r\n         insertAnalyzeButton();\r\n       }\r\n-      \r\n-      // 検索ボックスが消えた場合の復旧（解析実行後のみ）\r\n-      if (allComments.length > 0 && !document.getElementById('ytcmtck-user-search')) {\r\n+        // 検索ボックスが消えた場合の復旧（解析実行後かつ表示設定がONの場合のみ）\r\n+      if (settings.showSearchBox && allComments.length > 0 && !document.getElementById('ytcmtck-user-search')) {\r\n         console.log('ytcmtck: 検索ボックスが消失、再挿入を試行');\r\n         setTimeout(() => {\r\n           // 再度チェックしてから再挿入\r\n           if (!document.getElementById('ytcmtck-user-search')) {\r\n"
                },
                {
                    "date": 1750438424391,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -362,18 +362,17 @@\n     searchTitle.style.fontSize = '14px';\r\n     searchTitle.style.fontWeight = '500';\r\n     searchTitle.style.color = '#0f0f0f';\r\n     searchContainer.appendChild(searchTitle);\r\n-    \r\n-    // 説明文を追加\r\n+      // 説明文を追加\r\n     const searchDescription = document.createElement('div');\r\n     searchDescription.style.fontSize = '12px';\r\n     searchDescription.style.color = '#666';\r\n     searchDescription.style.marginBottom = '12px';\r\n     searchDescription.style.lineHeight = '1.4';\r\n     \r\n     if (allComments.length === 0) {\r\n-      searchDescription.textContent = '先に「🔍コメント解析」ボタンを押してから使用してください';\r\n+      searchDescription.textContent = '現在表示されているコメントから検索できます（解析後はより多くのコメントから検索可能）';\r\n     } else {\r\n       searchDescription.textContent = `${allComments.length}件のコメントから検索できます`;\r\n     }\r\n     searchContainer.appendChild(searchDescription);\r\n@@ -383,22 +382,16 @@\n     searchInputContainer.style.display = 'flex';\r\n     searchInputContainer.style.gap = '8px';\r\n     searchInputContainer.style.marginBottom = '12px';    const searchInput = document.createElement('input');\r\n     searchInput.type = 'text';\r\n-    searchInput.placeholder = allComments.length === 0 ? '解析後に使用可能です' : '@ユーザーID を入力';\r\n+    searchInput.placeholder = '@ユーザーID を入力';\r\n     searchInput.style.flex = '1';\r\n     searchInput.style.padding = '8px 12px';\r\n     searchInput.style.border = '1px solid #ccc';\r\n     searchInput.style.borderRadius = '20px';\r\n     searchInput.style.fontSize = '14px';\r\n     searchInput.style.outline = 'none';\r\n     searchInput.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n-    \r\n-    // 解析前は入力を無効化\r\n-    if (allComments.length === 0) {\r\n-      searchInput.disabled = false; // 無効化はしないが、検索時にメッセージを表示\r\n-      searchInput.style.backgroundColor = '#f9f9f9';\r\n-    }\r\n \r\n     const searchButton = document.createElement('button');\r\n     searchButton.textContent = '検索';\r\n     searchButton.style.padding = '8px 16px';\r\n@@ -432,31 +425,22 @@\n         searchResultsContainer.style.display = 'none';\r\n         return;\r\n       }\r\n \r\n-      // 解析前の場合の処理\r\n-      if (allComments.length === 0) {\r\n-        searchResultsContainer.innerHTML = '';\r\n-        searchResultsContainer.style.display = 'block';\r\n-        \r\n-        const noAnalysisMessage = document.createElement('div');\r\n-        noAnalysisMessage.innerHTML = `\r\n-          <div style=\"text-align: center; padding: 20px; color: #666;\">\r\n-            <div style=\"font-size: 18px; margin-bottom: 8px;\">🔍</div>\r\n-            <div style=\"font-weight: 500; margin-bottom: 8px;\">まず「🔍コメント解析」ボタンを押してください</div>\r\n-            <div style=\"font-size: 14px;\">解析後にユーザーIDで検索できるようになります</div>\r\n-          </div>\r\n-        `;\r\n-        searchResultsContainer.appendChild(noAnalysisMessage);\r\n-        return;\r\n-      }\r\n-\r\n       // @を自動追加\r\n       const searchQuery = query.startsWith('@') ? query : '@' + query;\r\n-      const results = allComments.filter(comment => \r\n-        comment.author.toLowerCase().includes(searchQuery.toLowerCase().substring(1))\r\n-      );\r\n+      let results = [];\r\n \r\n+      // 解析済みのコメントがある場合はそれを使用\r\n+      if (allComments.length > 0) {\r\n+        results = allComments.filter(comment => \r\n+          comment.author.toLowerCase().includes(searchQuery.toLowerCase().substring(1))\r\n+        );\r\n+      } else {\r\n+        // 解析前の場合は、現在ページ上にあるコメントを検索\r\n+        results = searchPageComments(searchQuery.substring(1));\r\n+      }\r\n+\r\n       displaySearchResults(results, searchQuery);\r\n     };\r\n \r\n     // イベントリスナー\r\n@@ -537,9 +521,52 @@\n     if (insertionSuccess) {\r\n       console.log('ytcmtck: ユーザー検索ボックスの挿入が完了しました');\r\n     } else {\r\n       console.log('ytcmtck: ユーザー検索ボックスの挿入に失敗しました');\r\n-    }\r\n+    }  }\r\n+\r\n+  // ページ上のコメントを検索する関数（解析前用）\r\n+  function searchPageComments(searchTerm) {\r\n+    const results = [];\r\n+    \r\n+    // 現在表示されているコメントを取得\r\n+    const commentElements = document.querySelectorAll('#contents ytd-comment-thread-renderer, #contents ytd-comment-view-model');\r\n+    \r\n+    commentElements.forEach((commentElement, index) => {\r\n+      try {\r\n+        // ユーザー名を取得\r\n+        const authorElement = commentElement.querySelector('#author-text span');\r\n+        const author = authorElement ? authorElement.textContent.trim() : '';\r\n+        \r\n+        // コメント本文を取得\r\n+        const contentElement = commentElement.querySelector('#content-text, #content span[dir=\"auto\"]');\r\n+        const text = contentElement ? contentElement.textContent.trim() : '';\r\n+        \r\n+        // プロフィール画像URLを取得\r\n+        const imgElement = commentElement.querySelector('img');\r\n+        const authorProfileImageUrl = imgElement ? imgElement.src : '';\r\n+        \r\n+        // 投稿時間を取得\r\n+        const timeElement = commentElement.querySelector('.published-time-text a, [class*=\"published-time\"] a');\r\n+        const publishedText = timeElement ? timeElement.textContent.trim() : '';\r\n+        \r\n+        // 検索条件にマッチするかチェック\r\n+        if (author.toLowerCase().includes(searchTerm.toLowerCase())) {\r\n+          results.push({\r\n+            author: author,\r\n+            text: text,\r\n+            authorProfileImageUrl: authorProfileImageUrl,\r\n+            publishedAt: publishedText,\r\n+            id: `page-comment-${index}`,\r\n+            element: commentElement // スクロール用\r\n+          });\r\n+        }\r\n+      } catch (error) {\r\n+        console.log('ytcmtck: コメント解析中にエラー:', error);\r\n+      }\r\n+    });\r\n+    \r\n+    return results;\r\n   }\r\n \r\n   // 検索結果を表示\r\n   function displaySearchResults(results, query) {\r\n@@ -606,12 +633,10 @@\n       const authorName = document.createElement('span');\r\n       authorName.textContent = comment.author;\r\n       authorName.style.fontSize = '14px';\r\n       authorName.style.fontWeight = '500';\r\n-      authorName.style.color = '#0f0f0f';\r\n-\r\n-      const timeAgo = document.createElement('span');\r\n-      timeAgo.textContent = ` • ${formatTimeAgo(comment.publishedAt)}`;\r\n+      authorName.style.color = '#0f0f0f';      const timeAgo = document.createElement('span');\r\n+      timeAgo.textContent = ` • ${comment.publishedAt || formatTimeAgo(comment.publishedAt)}`;\r\n       timeAgo.style.fontSize = '12px';\r\n       timeAgo.style.color = '#606060';\r\n \r\n       authorInfo.appendChild(authorImage);\r\n@@ -624,24 +649,37 @@\n       commentText.style.color = '#0f0f0f';\r\n       commentText.style.lineHeight = '1.4';\r\n \r\n       resultItem.appendChild(authorInfo);\r\n-      resultItem.appendChild(commentText);\r\n-\r\n-      // クリックでコメントにスクロール\r\n+      resultItem.appendChild(commentText);      // クリックでコメントにスクロール\r\n       resultItem.addEventListener('click', () => {\r\n-        const commentElement = document.querySelector(`[data-ytcmtck-hidden=\"true\"] a[href*=\"lc=${comment.id}\"]`);\r\n-        if (commentElement) {\r\n-          commentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });\r\n-          // ハイライト効果\r\n-          const highlightElement = commentElement.closest('[data-ytcmtck-hidden=\"true\"]');\r\n-          if (highlightElement) {\r\n-            const originalBackground = highlightElement.style.backgroundColor;\r\n-            highlightElement.style.backgroundColor = '#fff3cd';\r\n+        // APIから取得したコメントの場合\r\n+        if (comment.id && comment.id.startsWith('page-comment-')) {\r\n+          // ページ上のコメント（解析前）\r\n+          if (comment.element) {\r\n+            comment.element.scrollIntoView({ behavior: 'smooth', block: 'center' });\r\n+            // ハイライト効果\r\n+            const originalBackground = comment.element.style.backgroundColor;\r\n+            comment.element.style.backgroundColor = '#fff3cd';\r\n             setTimeout(() => {\r\n-              highlightElement.style.backgroundColor = originalBackground;\r\n+              comment.element.style.backgroundColor = originalBackground;\r\n             }, 2000);\r\n           }\r\n+        } else {\r\n+          // 解析後のコメント\r\n+          const commentElement = document.querySelector(`[data-ytcmtck-hidden=\"true\"] a[href*=\"lc=${comment.id}\"]`);\r\n+          if (commentElement) {\r\n+            commentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });\r\n+            // ハイライト効果\r\n+            const highlightElement = commentElement.closest('[data-ytcmtck-hidden=\"true\"]');\r\n+            if (highlightElement) {\r\n+              const originalBackground = highlightElement.style.backgroundColor;\r\n+              highlightElement.style.backgroundColor = '#fff3cd';\r\n+              setTimeout(() => {\r\n+                highlightElement.style.backgroundColor = originalBackground;\r\n+              }, 2000);\r\n+            }\r\n+          }\r\n         }\r\n       });\r\n \r\n       resultsList.appendChild(resultItem);\r\n@@ -885,9 +923,8 @@\n     } else {\r\n       return '今';\r\n     }\r\n   }\r\n-\r\n   // 検索ボックスの状態を更新\r\n   function updateSearchBoxState() {\r\n     const searchBox = document.getElementById('ytcmtck-user-search');\r\n     if (!searchBox) return;\r\n@@ -896,22 +933,17 @@\n     const searchInput = searchBox.querySelector('input');\r\n     \r\n     if (searchDescription) {\r\n       if (allComments.length === 0) {\r\n-        searchDescription.textContent = '先に「🔍コメント解析」ボタンを押してからご利用ください';\r\n+        searchDescription.textContent = '現在表示されているコメントから検索できます（解析後はより多くのコメントから検索可能）';\r\n       } else {\r\n         searchDescription.textContent = `${allComments.length}件のコメントから検索できます`;\r\n       }\r\n     }\r\n     \r\n     if (searchInput) {\r\n-      if (allComments.length === 0) {\r\n-        searchInput.placeholder = '解析後に利用可能になります';\r\n-        searchInput.style.backgroundColor = '#f9f9f9';\r\n-      } else {\r\n-        searchInput.placeholder = '@ユーザーID を入力';\r\n-        searchInput.style.backgroundColor = '#ffffff';\r\n-      }\r\n+      searchInput.placeholder = '@ユーザーID を入力';\r\n+      searchInput.style.backgroundColor = '#ffffff';\r\n     }\r\n   }\r\n \r\n   async function onAnalyzeClick() {\r\n"
                }
            ],
            "date": 1750310390265,
            "name": "Commit-0",
            "content": "// YouTubeのコメント欄付近に「コメントを解析する」ボタンを設置し、クリック時に解析・結果表示\r\n(function() {\r\n  // コメント欄の親要素を探す（新仕様: #additional-section内部）\r\n  function findInsertTarget() {\r\n    const commentsHeader = document.querySelector('ytd-comments-header-renderer');\r\n    if (!commentsHeader) return null;\r\n    const additional = commentsHeader.querySelector('#additional-section');\r\n    return additional;\r\n  }\r\n\r\n  function insertAnalyzeButton() {\r\n    // 既にボタンがある場合は何もしない\r\n    if (document.getElementById('ytcmtck-analyze-btn')) return;\r\n    \r\n    const additional = findInsertTarget();\r\n    if (!additional) {\r\n      console.log('ytcmtck: #additional-section not found, retrying...');\r\n      return;\r\n    }\r\n      const btn = document.createElement('button');\r\n    btn.id = 'ytcmtck-analyze-btn';\r\n    btn.textContent = 'コメント解析';\r\n    btn.style.marginLeft = '16px';\r\n    btn.style.marginTop = '2px';\r\n    btn.style.background = 'transparent';\r\n    btn.style.color = '#0f0f0f';\r\n    btn.style.border = '0px';\r\n    btn.style.cursor = 'pointer';\r\n    btn.style.fontSize = '1.4rem';\r\n    btn.style.fontWeight = '500';\r\n    btn.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n    btn.style.height = '36px';\r\n    btn.style.display = 'flex';\r\n    btn.style.alignItems = 'top';\r\n    btn.style.transition = 'background-color 0.1s ease';\r\n    \r\n    // #additional-section内部の最後に挿入\r\n    additional.appendChild(btn);\r\n    btn.addEventListener('click', onAnalyzeClick);\r\n    console.log('ytcmtck: 解析ボタンを挿入しました');\r\n  }\r\n\r\n  // MutationObserverでDOM変更を監視\r\n  function startObserver() {\r\n    const observer = new MutationObserver((mutations) => {\r\n      let shouldCheck = false;\r\n      mutations.forEach((mutation) => {\r\n        if (mutation.type === 'childList') {\r\n          mutation.addedNodes.forEach((node) => {\r\n            if (node.nodeType === 1) { // Element node\r\n              if (node.matches && (\r\n                node.matches('ytd-comments-header-renderer') ||\r\n                node.querySelector && node.querySelector('ytd-comments-header-renderer')\r\n              )) {\r\n                shouldCheck = true;\r\n              }\r\n            }\r\n          });\r\n        }\r\n      });\r\n      \r\n      if (shouldCheck) {\r\n        setTimeout(insertAnalyzeButton, 500);\r\n      }\r\n    });\r\n\r\n    observer.observe(document.body, {\r\n      childList: true,\r\n      subtree: true\r\n    });\r\n    \r\n    return observer;\r\n  }  function showResult(message, isFinal) {\r\n    let result = document.getElementById('ytcmtck-analyze-result');\r\n    if (!result) {\r\n      result = document.createElement('div');\r\n      result.id = 'ytcmtck-analyze-result';\r\n      result.style.margin = '16px 0';\r\n      result.style.padding = '16px';\r\n      result.style.background = '#f9f9f9';\r\n      result.style.border = '1px solid #ddd';\r\n      result.style.borderRadius = '8px';\r\n      result.style.fontSize = '16px';\r\n      result.style.lineHeight = '1.5';\r\n      result.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n      result.style.whiteSpace = 'pre-line';\r\n      const commentSection = document.querySelector('#comments');\r\n      if (commentSection) commentSection.prepend(result);\r\n    }\r\n    result.textContent = message;\r\n    if (isFinal) {\r\n      result.style.background = '#e6ffe6';\r\n      result.style.fontWeight = '500';\r\n      // 5秒後に自動で削除\r\n      setTimeout(() => {\r\n        if (result && result.parentNode) {\r\n          result.remove();\r\n        }\r\n      }, 5000);\r\n    }\r\n  }\r\n\r\n  // ★APIキーをここに設定（ご自身のYouTube Data APIキーに差し替えてください）\r\n  const YOUTUBE_API_KEY = 'AIzaSyCB9iLVqz1AsLrYk83tILnILa7n6OzfEkg';\r\n\r\n\r\n  // 動画IDをURLから取得\r\n  function getVideoId() {\r\n    const url = new URL(location.href);\r\n    return url.searchParams.get('v');\r\n  }  // YouTube Data APIでコメントを取得\r\n  async function fetchComments(videoId) {\r\n    if (!videoId) return { count: 0, comments: [] };\r\n    const apiUrl = `https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${videoId}&key=${YOUTUBE_API_KEY}&maxResults=100`;\r\n    try {\r\n      const res = await fetch(apiUrl);\r\n      const data = await res.json();\r\n      if (data.error) {\r\n        console.error('YouTube API Error:', data.error);\r\n        return { count: 0, comments: [] };\r\n      }\r\n      const comments = data.items ? data.items.map(item => ({\r\n        author: item.snippet.topLevelComment.snippet.authorDisplayName,\r\n        authorProfileImageUrl: item.snippet.topLevelComment.snippet.authorProfileImageUrl,\r\n        authorChannelUrl: item.snippet.topLevelComment.snippet.authorChannelUrl || '#',\r\n        text: item.snippet.topLevelComment.snippet.textDisplay,\r\n        publishedAt: item.snippet.topLevelComment.snippet.publishedAt,\r\n        updatedAt: item.snippet.topLevelComment.snippet.updatedAt,\r\n        likeCount: item.snippet.topLevelComment.snippet.likeCount || 0,\r\n        id: item.snippet.topLevelComment.id\r\n      })) : [];\r\n      return { count: comments.length, comments: comments };\r\n    } catch (e) {\r\n      console.error('API fetch error:', e);\r\n      return { count: 0, comments: [] };\r\n    }\r\n  }\r\n  // YouTubeの時間表示形式に変換\r\n  function formatTimeAgo(publishedAt) {\r\n    const now = new Date();\r\n    const published = new Date(publishedAt);\r\n    const diffMs = now - published;\r\n    \r\n    const minutes = Math.floor(diffMs / (1000 * 60));\r\n    const hours = Math.floor(diffMs / (1000 * 60 * 60));\r\n    const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));\r\n    const weeks = Math.floor(days / 7);\r\n    const months = Math.floor(days / 30);\r\n    const years = Math.floor(days / 365);\r\n\r\n    if (years > 0) {\r\n      return `${years} 年前`;\r\n    } else if (months > 0) {\r\n      return `${months} か月前`;\r\n    } else if (weeks > 0) {\r\n      return `${weeks} 週間前`;\r\n    } else if (days > 0) {\r\n      return `${days} 日前`;\r\n    } else if (hours > 0) {\r\n      return `${hours} 時間前`;\r\n    } else if (minutes > 0) {\r\n      return `${minutes} 分前`;\r\n    } else {\r\n      return '今';\r\n    }\r\n  }  async function onAnalyzeClick() {\r\n    showResult('解析中...', false);\r\n    \r\n    const videoId = getVideoId();\r\n    if (!videoId) {\r\n      showResult('エラー: 動画IDが取得できませんでした', true);\r\n      return;\r\n    }\r\n    \r\n    const ytComments = document.querySelectorAll('#contents #content-text');\r\n    const ytCount = ytComments.length;\r\n    \r\n    await new Promise(r => setTimeout(r, 1000));\r\n    const apiData = await fetchComments(videoId);\r\n    const apiCount = apiData.count;\r\n    \r\n    showResult('解析が完了しました。', false);\r\n    await new Promise(r => setTimeout(r, 1000));\r\n    \r\n    let resultMsg = '解析結果：\\n';\r\n    \r\n    if (ytCount === apiCount) {\r\n      resultMsg += '全てのコメントが表示されています。';\r\n    } else {\r\n      const hiddenCount = Math.max(0, apiCount - ytCount);\r\n      resultMsg += '表示されていないコメントが見つかったため、コメント欄のトップに表示しました';\r\n      const hiddenComments = apiData.comments.slice(ytCount);\r\n      if (hiddenComments.length > 0) {\r\n        const newHiddenComments = hiddenComments.filter(comment => !displayedCommentIds.has(comment.id));\r\n        if (newHiddenComments.length > 0) {\r\n          newHiddenComments.forEach((comment, index) => {\r\n            displayedCommentIds.add(comment.id);\r\n            const commentElement = document.createElement('ytd-comment-view-model');\r\n            commentElement.className = 'style-scope ytd-comment-thread-renderer';\r\n            commentElement.setAttribute('data-ytcmtck-hidden', 'true');\r\n            commentElement.style.borderRadius = '8px';\r\n            commentElement.style.marginBottom = '16px';\r\n            commentElement.innerHTML = `\r\n            <div id=\"body\" class=\"style-scope ytd-comment-view-model\">              <div id=\"author-thumbnail\" class=\"style-scope ytd-comment-view-model\">\r\n                <button id=\"author-thumbnail-button\" class=\"style-scope ytd-comment-view-model\" style=\"border: none; background: none; padding: 0; cursor: pointer;\" aria-label=\"${comment.author}\">\r\n                  <yt-img-shadow fit=\"\" height=\"40\" width=\"40\" class=\"style-scope ytd-comment-view-model no-transition\" style=\"background-color: transparent;\">\r\n                    <img style=\"width: 40px; height: 40px; border-radius: 50%; object-fit: cover;\" src=\"${comment.authorProfileImageUrl}\" alt=\"${comment.author}\" onerror=\"this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFNUU3RUIiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNiIgcj0iNiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNMzQgMzJDMzQgMjYuNDc3MiAyOS41MjI4IDIyIDI0IDIySDIwSDEyQzEwLjg5NTQgMjIgMTAgMjIuODk1NCAxMCAyNFYzNEgzNFYzMloiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'\">\r\n                  </yt-img-shadow>\r\n                </button>\r\n              </div>\r\n              <div id=\"main\" class=\"style-scope ytd-comment-view-model\">\r\n                <div id=\"header\" class=\"style-scope ytd-comment-view-model\" style=\"display: flex; align-items: center; flex-wrap: wrap; gap: 8px;\">\r\n                  <h3 class=\"style-scope ytd-comment-view-model\" style=\"margin: 0; font-size: 13px; line-height: 18px; font-weight: 500;\"> \r\n                    <a class=\"yt-simple-endpoint style-scope ytd-comment-view-model\" href=\"${comment.authorChannelUrl}\" style=\"color: #0f0f0f; text-decoration: none;\">\r\n                      <span class=\"style-scope ytd-comment-view-model\">${comment.author}</span>\r\n                    </a>\r\n                  </h3>\r\n                  <span dir=\"auto\" style=\"color: #606060; font-size: 12px; line-height: 18px;\">\r\n                    <a class=\"yt-simple-endpoint style-scope ytd-comment-view-model\" href=\"/watch?v=${getVideoId()}&lc=${comment.id}\" style=\"color: inherit; text-decoration: none;\">\r\n                      ${formatTimeAgo(comment.publishedAt)}\r\n                    </a>\r\n                  </span>\r\n                </div>\r\n                <div style=\"margin-top: 2px;\">\r\n                  <span style=\"color: #0f0f0f; font-size: 14px; line-height: 20px; white-space: pre-wrap;\">${comment.text}</span>\r\n                </div>                <div style=\"margin-top: 8px; display: flex; align-items: center; gap: 8px;\">\r\n                  <button style=\"background: none; border: none; padding: 0px; border-radius: 18px; cursor: pointer; display: flex; align-items: center; gap: 6px;\" onmouseover=\"this.style.backgroundColor='#f2f2f2'\" onmouseout=\"this.style.backgroundColor='transparent'\" title=\"高評価\">\r\n                    <svg width=\"25\" height=\"25\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n                      <path d=\"M18.77 11h-4.23l1.52-4.94C16.38 5.03 15.54 4 14.38 4c-.58 0-1.14.24-1.52.65L7 11H3v10h14.43c1.06 0 1.98-.67 2.19-1.61l1.34-6c.27-1.24-.78-2.39-2.19-2.39zM7 20H4v-8h3v8zm12.98-6.83-1.34 6c-.1.48-.61.83-1.21.83H8v-8.61l5.6-6.06c.19-.21.48-.33.78-.33.26 0 .5.11.63.3.07.1.15.26.09.47l-1.52 4.94-.4 1.29h5.58c.41 0 .8.17 1.03.46.13.15.26.4.19.71z\"/>\r\n                    </svg>\r\n                    ${comment.likeCount > 0 ? `<span style=\"font-size: 12px; color: #606060;\">${comment.likeCount}</span>` : ''}\r\n                  </button>\r\n                  <button style=\"background: none; border: none; border-radius: 18px; padding: 0px; cursor: pointer; display: flex; align-items: center;\" onmouseover=\"this.style.backgroundColor='#f2f2f2'\" onmouseout=\"this.style.backgroundColor='transparent'\">\r\n                    <svg width=\"25\" height=\"25\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n                      <path d=\"M17 4H6.57c-1.07 0-1.98.67-2.19 1.61l-1.34 6C2.77 12.85 3.82 14 5.23 14h4.23l-1.52 4.94C7.62 19.97 8.46 21 9.62 21c.58 0 1.14-.24 1.52-.65L17 14h4V4h-4zm-6.6 15.67c-.19.21-.48.33-.78.33-.26 0-.5-.11-.63-.3-.07-.1-.15-.26-.09-.47l1.52-4.94.4-1.29H5.23c-.41 0-.8-.17-1.03-.46-.12-.15-.25-.4-.18-.72l1.34-6c.1-.47.61-.82 1.21-.82H16v8.61l-5.6 6.06zM20 13h-3V5h3v8z\"/>\r\n                    </svg>\r\n                  </button>\r\n                  <button style=\"background: none; border: none; padding: 6px 16px; border-radius: 18px; cursor: pointer; font-size: 12px; font-weight: 500; onmouseover=\"this.style.backgroundColor='#f2f2f2'\" onmouseout=\"this.style.backgroundColor='transparent'\">\r\n                    返信\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          `;\r\n            const commentSection = document.querySelector('#comments #contents');\r\n            if (commentSection) commentSection.prepend(commentElement);\r\n          });\r\n        }\r\n      }\r\n    }\r\n    showResult(resultMsg, true);\r\n  }\r\n  // 動的ページ対応とMutationObserver\r\n  let lastUrl = location.href;\r\n  let checkInterval;\r\n  let observer;\r\n\r\n  function startMonitoring() {\r\n    // MutationObserverを開始\r\n    observer = startObserver();\r\n    \r\n    // URLチェック用インターバル\r\n    checkInterval = setInterval(() => {\r\n      if (location.href !== lastUrl) {\r\n        lastUrl = location.href;\r\n        console.log('ytcmtck: ページ遷移を検出、ボタン再挿入を試行');\r\n        setTimeout(insertAnalyzeButton, 1000);\r\n        setTimeout(insertAnalyzeButton, 3000); // 遅延読み込み対応\r\n      }\r\n      \r\n      // ボタンが消えた場合の復旧\r\n      if (!document.getElementById('ytcmtck-analyze-btn') && findInsertTarget()) {\r\n        console.log('ytcmtck: ボタンが消失、再挿入');\r\n        insertAnalyzeButton();\r\n      }\r\n    }, 2000);\r\n  }\r\n\r\n  // 初期化\r\n  function init() {\r\n    // 複数回試行で確実に挿入\r\n    setTimeout(insertAnalyzeButton, 1000);\r\n    setTimeout(insertAnalyzeButton, 3000);\r\n    setTimeout(insertAnalyzeButton, 5000);\r\n    \r\n    // 監視開始\r\n    startMonitoring();\r\n  }\r\n\r\n  // ページ読み込み完了後に初期化\r\n  if (document.readyState === 'loading') {\r\n    document.addEventListener('DOMContentLoaded', init);\r\n  } else {\r\n    init();\r\n  }\r\n\r\n  // 既に表示済みのコメントIDを記録する配列\r\n  let displayedCommentIds = new Set();\r\n\r\n  // 既存の未表示コメントを削除する関数\r\n  function removeExistingHiddenComments() {\r\n    const existingComments = document.querySelectorAll('[data-ytcmtck-hidden=\"true\"]');\r\n    existingComments.forEach(comment => comment.remove());\r\n    addLog(`既存の未表示コメント ${existingComments.length}件を削除`, 'progress');\r\n  }\r\n})();\r\n"
        }
    ]
}