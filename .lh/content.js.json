{
    "sourceFile": "content.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1750249241124,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1750249241124,
            "name": "Commit-0",
            "content": "// YouTubeのコメント欄付近に「コメントを解析する」ボタンを設置し、クリック時に解析・結果表示\r\n(function() {\r\n  // コメント欄の親要素を探す（新仕様: #additional-section内部）\r\n  function findInsertTarget() {\r\n    const commentsHeader = document.querySelector('ytd-comments-header-renderer');\r\n    if (!commentsHeader) return null;\r\n    const additional = commentsHeader.querySelector('#additional-section');\r\n    return additional;\r\n  }\r\n\r\n  function insertAnalyzeButton() {\r\n    // 既にボタンがある場合は何もしない\r\n    if (document.getElementById('ytcmtck-analyze-btn')) return;\r\n    \r\n    const additional = findInsertTarget();\r\n    if (!additional) {\r\n      console.log('ytcmtck: #additional-section not found, retrying...');\r\n      return;\r\n    }\r\n      const btn = document.createElement('button');\r\n    btn.id = 'ytcmtck-analyze-btn';\r\n    btn.textContent = 'コメント解析';\r\n    btn.style.marginLeft = '16px';\r\n    btn.style.marginTop = '2px';\r\n    btn.style.background = 'transparent';\r\n    btn.style.color = '#0f0f0f';\r\n    btn.style.border = '0px';\r\n    btn.style.cursor = 'pointer';\r\n    btn.style.fontSize = '1.4rem';\r\n    btn.style.fontWeight = '500';\r\n    btn.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n    btn.style.height = '36px';\r\n    btn.style.display = 'flex';\r\n    btn.style.alignItems = 'top';\r\n    btn.style.transition = 'background-color 0.1s ease';\r\n    \r\n    // #additional-section内部の最後に挿入\r\n    additional.appendChild(btn);\r\n    btn.addEventListener('click', onAnalyzeClick);\r\n    console.log('ytcmtck: 解析ボタンを挿入しました');\r\n  }\r\n\r\n  // MutationObserverでDOM変更を監視\r\n  function startObserver() {\r\n    const observer = new MutationObserver((mutations) => {\r\n      let shouldCheck = false;\r\n      mutations.forEach((mutation) => {\r\n        if (mutation.type === 'childList') {\r\n          mutation.addedNodes.forEach((node) => {\r\n            if (node.nodeType === 1) { // Element node\r\n              if (node.matches && (\r\n                node.matches('ytd-comments-header-renderer') ||\r\n                node.querySelector && node.querySelector('ytd-comments-header-renderer')\r\n              )) {\r\n                shouldCheck = true;\r\n              }\r\n            }\r\n          });\r\n        }\r\n      });\r\n      \r\n      if (shouldCheck) {\r\n        setTimeout(insertAnalyzeButton, 500);\r\n      }\r\n    });\r\n\r\n    observer.observe(document.body, {\r\n      childList: true,\r\n      subtree: true\r\n    });\r\n    \r\n    return observer;\r\n  }  function showResult(message, isFinal) {\r\n    let result = document.getElementById('ytcmtck-analyze-result');\r\n    if (!result) {\r\n      result = document.createElement('div');\r\n      result.id = 'ytcmtck-analyze-result';\r\n      result.style.margin = '16px 0';\r\n      result.style.padding = '16px';\r\n      result.style.background = '#f9f9f9';\r\n      result.style.border = '1px solid #ddd';\r\n      result.style.borderRadius = '8px';\r\n      result.style.fontSize = '16px';\r\n      result.style.lineHeight = '1.5';\r\n      result.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n      result.style.whiteSpace = 'pre-line';\r\n      const commentSection = document.querySelector('#comments');\r\n      if (commentSection) commentSection.prepend(result);\r\n    }\r\n    result.textContent = message;\r\n    if (isFinal) {\r\n      result.style.background = '#e6ffe6';\r\n      result.style.fontWeight = '500';\r\n      // 5秒後に自動で削除\r\n      setTimeout(() => {\r\n        if (result && result.parentNode) {\r\n          result.remove();\r\n          addLog('解析結果表示を自動で削除しました', 'info');\r\n        }\r\n      }, 5000);\r\n    }\r\n  }\r\n\r\n  // ★APIキーをここに設定（ご自身のYouTube Data APIキーに差し替えてください）\r\n  const YOUTUBE_API_KEY = 'あなたのAPIキーを入力';\r\n\r\n  // 動画IDをURLから取得\r\n  function getVideoId() {\r\n    const url = new URL(location.href);\r\n    return url.searchParams.get('v');\r\n  }  // YouTube Data APIでコメントを取得\r\n  async function fetchComments(videoId) {\r\n    if (!videoId) return { count: 0, comments: [] };\r\n    const apiUrl = `https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${videoId}&key=${YOUTUBE_API_KEY}&maxResults=100`;\r\n    try {\r\n      const res = await fetch(apiUrl);\r\n      const data = await res.json();\r\n      if (data.error) {\r\n        console.error('YouTube API Error:', data.error);\r\n        return { count: 0, comments: [] };\r\n      }\r\n      const comments = data.items ? data.items.map(item => ({\r\n        author: item.snippet.topLevelComment.snippet.authorDisplayName,\r\n        authorProfileImageUrl: item.snippet.topLevelComment.snippet.authorProfileImageUrl,\r\n        authorChannelUrl: item.snippet.topLevelComment.snippet.authorChannelUrl || '#',\r\n        text: item.snippet.topLevelComment.snippet.textDisplay,\r\n        publishedAt: item.snippet.topLevelComment.snippet.publishedAt,\r\n        updatedAt: item.snippet.topLevelComment.snippet.updatedAt,\r\n        likeCount: item.snippet.topLevelComment.snippet.likeCount || 0,\r\n        id: item.snippet.topLevelComment.id\r\n      })) : [];\r\n      return { count: comments.length, comments: comments };\r\n    } catch (e) {\r\n      console.error('API fetch error:', e);\r\n      return { count: 0, comments: [] };\r\n    }\r\n  }\r\n  // YouTubeの時間表示形式に変換\r\n  function formatTimeAgo(publishedAt) {\r\n    const now = new Date();\r\n    const published = new Date(publishedAt);\r\n    const diffMs = now - published;\r\n    \r\n    const minutes = Math.floor(diffMs / (1000 * 60));\r\n    const hours = Math.floor(diffMs / (1000 * 60 * 60));\r\n    const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));\r\n    const weeks = Math.floor(days / 7);\r\n    const months = Math.floor(days / 30);\r\n    const years = Math.floor(days / 365);\r\n\r\n    if (years > 0) {\r\n      return `${years} 年前`;\r\n    } else if (months > 0) {\r\n      return `${months} か月前`;\r\n    } else if (weeks > 0) {\r\n      return `${weeks} 週間前`;\r\n    } else if (days > 0) {\r\n      return `${days} 日前`;\r\n    } else if (hours > 0) {\r\n      return `${hours} 時間前`;\r\n    } else if (minutes > 0) {\r\n      return `${minutes} 分前`;\r\n    } else {\r\n      return '今';\r\n    }\r\n  }  async function onAnalyzeClick() {\r\n    // ログポップアップを表示して解析開始\r\n    addLog('コメント解析を開始します', 'start');\r\n    showResult('解析中...', false);\r\n    \r\n    addLog('動画IDを取得中...', 'progress');\r\n    const videoId = getVideoId();\r\n    if (!videoId) {\r\n      addLog('エラー: 動画IDが取得できませんでした', 'error');\r\n      showResult('エラー: 動画IDが取得できませんでした', true);\r\n      return;\r\n    }\r\n    addLog(`動画ID: ${videoId}`, 'success');\r\n    \r\n    addLog('YouTube上の表示コメント数を取得中...', 'progress');\r\n    const ytComments = document.querySelectorAll('#contents #content-text');\r\n    const ytCount = ytComments.length;\r\n    addLog(`YouTube上の表示コメント: ${ytCount}件`, 'success');\r\n    \r\n    await new Promise(r => setTimeout(r, 1000));\r\n    addLog('YouTube Data APIでコメントを取得中...', 'api');\r\n    \r\n    const apiData = await fetchComments(videoId);\r\n    const apiCount = apiData.count;\r\n    \r\n    if (apiData.count === 0 && apiData.comments.length === 0) {\r\n      addLog('警告: APIからコメントを取得できませんでした (APIキーまたは権限を確認してください)', 'error');\r\n    } else {\r\n      addLog(`API取得コメント: ${apiCount}件`, 'success');\r\n    }\r\n    \r\n    showResult('解析が完了しました。', false);\r\n    addLog('解析が完了しました', 'success');\r\n    \r\n    await new Promise(r => setTimeout(r, 1000));\r\n    \r\n    let resultMsg = '解析結果：\\n';\r\n    \r\n    if (ytCount === apiCount) {\r\n      resultMsg += '全てのコメントが表示されています。';\r\n      addLog('結果: 全てのコメントが表示されています', 'success');\r\n    } else {\r\n      const hiddenCount = Math.max(0, apiCount - ytCount);\r\n      resultMsg += '表示されていないコメントが見つかったため、コメント欄のトップに表示しました';\r\n      addLog(`未表示コメント ${hiddenCount}件を検出`, 'progress');      // APIで取得した未表示コメントを上部に表示\r\n      const hiddenComments = apiData.comments.slice(ytCount); // 表示分を除いた残り\r\n      if (hiddenComments.length > 0) {\r\n        // 新しい未表示コメントをフィルタリング（重複除去）\r\n        const newHiddenComments = hiddenComments.filter(comment => !displayedCommentIds.has(comment.id));\r\n        \r\n        if (newHiddenComments.length > 0) {\r\n          addLog(`新規未表示コメント ${newHiddenComments.length}件をページ上部に表示中...`, 'progress');\r\n          newHiddenComments.forEach((comment, index) => {\r\n            addLog(`未表示コメント ${index + 1}/${newHiddenComments.length} を挿入: ${comment.author}`, 'progress');\r\n            \r\n            // 表示済みリストに追加\r\n            displayedCommentIds.add(comment.id);\r\n            \r\n            const commentElement = document.createElement('ytd-comment-view-model');\r\n            commentElement.className = 'style-scope ytd-comment-thread-renderer';\r\n            commentElement.setAttribute('data-ytcmtck-hidden', 'true'); // 識別用マーカー\r\n            commentElement.style.borderRadius = '8px';\r\n            commentElement.style.marginBottom = '16px';\r\n            commentElement.innerHTML = `\r\n            \r\n            <div id=\"body\" class=\"style-scope ytd-comment-view-model\">              <div id=\"author-thumbnail\" class=\"style-scope ytd-comment-view-model\">\r\n                <button id=\"author-thumbnail-button\" class=\"style-scope ytd-comment-view-model\" style=\"border: none; background: none; padding: 0; cursor: pointer;\" aria-label=\"${comment.author}\">\r\n                  <yt-img-shadow fit=\"\" height=\"40\" width=\"40\" class=\"style-scope ytd-comment-view-model no-transition\" style=\"background-color: transparent;\">\r\n                    <img style=\"width: 40px; height: 40px; border-radius: 50%; object-fit: cover;\" src=\"${comment.authorProfileImageUrl}\" alt=\"${comment.author}\" onerror=\"this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFNUU3RUIiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNiIgcj0iNiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNMzQgMzJDMzQgMjYuNDc3MiAyOS41MjI4IDIyIDI0IDIySDIwSDEyQzEwLjg5NTQgMjIgMTAgMjIuODk1NCAxMCAyNFYzNEgzNFYzMloiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'\">\r\n                  </yt-img-shadow>\r\n                </button>\r\n              </div>\r\n              <div id=\"main\" class=\"style-scope ytd-comment-view-model\">\r\n                <div id=\"header\" class=\"style-scope ytd-comment-view-model\" style=\"display: flex; align-items: center; flex-wrap: wrap; gap: 8px;\">\r\n                  <h3 class=\"style-scope ytd-comment-view-model\" style=\"margin: 0; font-size: 13px; line-height: 18px; font-weight: 500;\"> \r\n                    <a class=\"yt-simple-endpoint style-scope ytd-comment-view-model\" href=\"${comment.authorChannelUrl}\" style=\"color: #0f0f0f; text-decoration: none;\">\r\n                      <span class=\"style-scope ytd-comment-view-model\">${comment.author}</span>\r\n                    </a>\r\n                  </h3>\r\n                  <span dir=\"auto\" style=\"color: #606060; font-size: 12px; line-height: 18px;\">\r\n                    <a class=\"yt-simple-endpoint style-scope ytd-comment-view-model\" href=\"/watch?v=${getVideoId()}&lc=${comment.id}\" style=\"color: inherit; text-decoration: none;\">\r\n                      ${formatTimeAgo(comment.publishedAt)}\r\n                    </a>\r\n                  </span>\r\n                </div>\r\n                <div style=\"margin-top: 2px;\">\r\n                  <span style=\"color: #0f0f0f; font-size: 14px; line-height: 20px; white-space: pre-wrap;\">${comment.text}</span>\r\n                </div>                <div style=\"margin-top: 8px; display: flex; align-items: center; gap: 8px;\">\r\n                  <button style=\"background: none; border: none; padding: 0px; border-radius: 18px; cursor: pointer; display: flex; align-items: center; gap: 6px;\" onmouseover=\"this.style.backgroundColor='#f2f2f2'\" onmouseout=\"this.style.backgroundColor='transparent'\" title=\"高評価\">\r\n                    <svg width=\"25\" height=\"25\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n                      <path d=\"M18.77 11h-4.23l1.52-4.94C16.38 5.03 15.54 4 14.38 4c-.58 0-1.14.24-1.52.65L7 11H3v10h14.43c1.06 0 1.98-.67 2.19-1.61l1.34-6c.27-1.24-.78-2.39-2.19-2.39zM7 20H4v-8h3v8zm12.98-6.83-1.34 6c-.1.48-.61.83-1.21.83H8v-8.61l5.6-6.06c.19-.21.48-.33.78-.33.26 0 .5.11.63.3.07.1.15.26.09.47l-1.52 4.94-.4 1.29h5.58c.41 0 .8.17 1.03.46.13.15.26.4.19.71z\"/>\r\n                    </svg>\r\n                    ${comment.likeCount > 0 ? `<span style=\"font-size: 12px; color: #606060;\">${comment.likeCount}</span>` : ''}\r\n                  </button>\r\n                  <button style=\"background: none; border: none; border-radius: 18px; padding: 0px; cursor: pointer; display: flex; align-items: center;\" onmouseover=\"this.style.backgroundColor='#f2f2f2'\" onmouseout=\"this.style.backgroundColor='transparent'\">\r\n                    <svg width=\"25\" height=\"25\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\r\n                      <path d=\"M17 4H6.57c-1.07 0-1.98.67-2.19 1.61l-1.34 6C2.77 12.85 3.82 14 5.23 14h4.23l-1.52 4.94C7.62 19.97 8.46 21 9.62 21c.58 0 1.14-.24 1.52-.65L17 14h4V4h-4zm-6.6 15.67c-.19.21-.48.33-.78.33-.26 0-.5-.11-.63-.3-.07-.1-.15-.26-.09-.47l1.52-4.94.4-1.29H5.23c-.41 0-.8-.17-1.03-.46-.12-.15-.25-.4-.18-.72l1.34-6c.1-.47.61-.82 1.21-.82H16v8.61l-5.6 6.06zM20 13h-3V5h3v8z\"/>\r\n                    </svg>\r\n                  </button>\r\n                  <button style=\"background: none; border: none; padding: 6px 16px; border-radius: 18px; cursor: pointer; font-size: 12px; font-weight: 500; onmouseover=\"this.style.backgroundColor='#f2f2f2'\" onmouseout=\"this.style.backgroundColor='transparent'\">\r\n                    返信\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          `;            const commentSection = document.querySelector('#comments #contents');\r\n            if (commentSection) commentSection.prepend(commentElement);\r\n          });          addLog(`${newHiddenComments.length}件の新規未表示コメントを表示しました`, 'success');\r\n          addLog(`累計表示済み未表示コメント: ${displayedCommentIds.size}件`, 'info');\r\n        } else {\r\n          addLog('新規未表示コメントは見つかりませんでした（既に表示済み）', 'info');\r\n          addLog(`累計表示済み未表示コメント: ${displayedCommentIds.size}件`, 'info');\r\n        }\r\n      }\r\n    }\r\n    showResult(resultMsg, true);\r\n    addLog('🎉 コメント解析が完了しました！', 'success');\r\n    \r\n    // 3秒後にログポップアップを自動で閉じる\r\n    setTimeout(() => {\r\n      addLog('ログを自動的に閉じます (手動で閉じることも可能)', 'info');\r\n      setTimeout(closeLogPopup, 2000);\r\n    }, 3000);\r\n  }\r\n  // 動的ページ対応とMutationObserver\r\n  let lastUrl = location.href;\r\n  let checkInterval;\r\n  let observer;\r\n\r\n  function startMonitoring() {\r\n    // MutationObserverを開始\r\n    observer = startObserver();\r\n    \r\n    // URLチェック用インターバル\r\n    checkInterval = setInterval(() => {\r\n      if (location.href !== lastUrl) {\r\n        lastUrl = location.href;\r\n        console.log('ytcmtck: ページ遷移を検出、ボタン再挿入を試行');\r\n        setTimeout(insertAnalyzeButton, 1000);\r\n        setTimeout(insertAnalyzeButton, 3000); // 遅延読み込み対応\r\n      }\r\n      \r\n      // ボタンが消えた場合の復旧\r\n      if (!document.getElementById('ytcmtck-analyze-btn') && findInsertTarget()) {\r\n        console.log('ytcmtck: ボタンが消失、再挿入');\r\n        insertAnalyzeButton();\r\n      }\r\n    }, 2000);\r\n  }\r\n\r\n  // 初期化\r\n  function init() {\r\n    // 複数回試行で確実に挿入\r\n    setTimeout(insertAnalyzeButton, 1000);\r\n    setTimeout(insertAnalyzeButton, 3000);\r\n    setTimeout(insertAnalyzeButton, 5000);\r\n    \r\n    // 監視開始\r\n    startMonitoring();\r\n  }\r\n\r\n  // ページ読み込み完了後に初期化\r\n  if (document.readyState === 'loading') {\r\n    document.addEventListener('DOMContentLoaded', init);\r\n  } else {\r\n    init();\r\n  }\r\n\r\n  // ログポップアップを作成・表示\r\n  function showLogPopup() {\r\n    let popup = document.getElementById('ytcmtck-log-popup');\r\n    if (!popup) {\r\n      popup = document.createElement('div');\r\n      popup.id = 'ytcmtck-log-popup';\r\n      popup.style.position = 'fixed';\r\n      popup.style.top = '20px';\r\n      popup.style.right = '20px';\r\n      popup.style.width = '400px';\r\n      popup.style.maxHeight = '500px';\r\n      popup.style.backgroundColor = '#fff';\r\n      popup.style.border = '2px solid #cc0000';\r\n      popup.style.borderRadius = '8px';\r\n      popup.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';\r\n      popup.style.zIndex = '10000';\r\n      popup.style.fontFamily = 'Roboto, Arial, sans-serif';\r\n      popup.style.fontSize = '14px';\r\n      popup.style.overflow = 'hidden';\r\n      \r\n      const header = document.createElement('div');\r\n      header.style.backgroundColor = '#cc0000';\r\n      header.style.color = '#fff';\r\n      header.style.padding = '12px';\r\n      header.style.fontWeight = 'bold';\r\n      header.style.display = 'flex';\r\n      header.style.justifyContent = 'space-between';\r\n      header.style.alignItems = 'center';\r\n      header.innerHTML = '📊 YouTubeコメント解析ログ';\r\n      \r\n      const closeBtn = document.createElement('button');\r\n      closeBtn.innerHTML = '×';\r\n      closeBtn.style.backgroundColor = 'transparent';\r\n      closeBtn.style.border = 'none';\r\n      closeBtn.style.color = '#fff';\r\n      closeBtn.style.fontSize = '18px';\r\n      closeBtn.style.cursor = 'pointer';\r\n      closeBtn.style.padding = '0';\r\n      closeBtn.style.width = '24px';\r\n      closeBtn.style.height = '24px';\r\n      closeBtn.onclick = () => popup.remove();\r\n      header.appendChild(closeBtn);\r\n      \r\n      const content = document.createElement('div');\r\n      content.id = 'ytcmtck-log-content';\r\n      content.style.padding = '16px';\r\n      content.style.maxHeight = '400px';\r\n      content.style.overflowY = 'auto';\r\n      content.style.lineHeight = '1.4';\r\n      \r\n      popup.appendChild(header);\r\n      popup.appendChild(content);\r\n      document.body.appendChild(popup);\r\n    }\r\n    return popup;\r\n  }\r\n\r\n  // ログを追加\r\n  function addLog(message, type = 'info') {\r\n    const popup = showLogPopup();\r\n    const content = document.getElementById('ytcmtck-log-content');\r\n    const logEntry = document.createElement('div');\r\n    logEntry.style.marginBottom = '8px';\r\n    logEntry.style.padding = '8px';\r\n    logEntry.style.borderRadius = '4px';\r\n    \r\n    const timestamp = new Date().toLocaleTimeString('ja-JP');\r\n    let icon = '';\r\n    let bgColor = '';\r\n    \r\n    switch(type) {\r\n      case 'start':\r\n        icon = '🚀';\r\n        bgColor = '#e3f2fd';\r\n        break;\r\n      case 'progress':\r\n        icon = '⏳';\r\n        bgColor = '#fff3e0';\r\n        break;\r\n      case 'success':\r\n        icon = '✅';\r\n        bgColor = '#e8f5e8';\r\n        break;\r\n      case 'error':\r\n        icon = '❌';\r\n        bgColor = '#ffebee';\r\n        break;\r\n      case 'api':\r\n        icon = '🔗';\r\n        bgColor = '#f3e5f5';\r\n        break;\r\n      default:\r\n        icon = 'ℹ️';\r\n        bgColor = '#f5f5f5';\r\n    }\r\n    \r\n    logEntry.style.backgroundColor = bgColor;\r\n    logEntry.innerHTML = `<span style=\"color: #666; font-size: 12px;\">${timestamp}</span> ${icon} ${message}`;\r\n    content.appendChild(logEntry);\r\n    content.scrollTop = content.scrollHeight;\r\n  }\r\n\r\n  // ログポップアップを閉じる\r\n  function closeLogPopup() {\r\n    const popup = document.getElementById('ytcmtck-log-popup');\r\n    if (popup) popup.remove();\r\n  }\r\n\r\n  // 既に表示済みのコメントIDを記録する配列\r\n  let displayedCommentIds = new Set();\r\n\r\n  // 既存の未表示コメントを削除する関数\r\n  function removeExistingHiddenComments() {\r\n    const existingComments = document.querySelectorAll('[data-ytcmtck-hidden=\"true\"]');\r\n    existingComments.forEach(comment => comment.remove());\r\n    addLog(`既存の未表示コメント ${existingComments.length}件を削除`, 'progress');\r\n  }\r\n})();\r\n"
        }
    ]
}